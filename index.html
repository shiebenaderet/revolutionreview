<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revolutionary War Study Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .nav-btn {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .nav-btn:active {
            transform: translateY(-1px);
        }

        .nav-btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .nav-btn.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: visible;
            margin: 20px 0;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 15px;
            position: relative;
        }

        .progress-bar .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #1a1a1a;
            font-weight: bold;
            white-space: nowrap;
            text-shadow:
                0 0 8px white,
                0 0 8px white,
                1px 1px 2px rgba(255, 255, 255, 0.9),
                -1px -1px 2px rgba(255, 255, 255, 0.9);
            z-index: 1;
        }

        .flashcard {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 20px 0;
        }

        .flashcard:hover {
            transform: scale(1.02);
        }

        .flashcard h3 {
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        .flashcard .definition {
            font-size: 1.2em;
            line-height: 1.6;
        }

        .flashcard .example {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            font-style: italic;
        }

        .question-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }

        .question-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .option {
            padding: 15px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1em;
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .option.selected {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .option.correct {
            border-color: #10b981;
            background: #d1fae5;
        }

        .option.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
        }

        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #d1fae5;
            border-left: 5px solid #10b981;
        }

        .feedback.incorrect {
            background: #fee2e2;
            border-left: 5px solid #ef4444;
        }

        .feedback h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            opacity: 0.9;
        }

        .weakness-list {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .weakness-list h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .weakness-item {
            padding: 10px;
            background: white;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .strength-list {
            background: #d1fae5;
            border-left: 5px solid #10b981;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .strength-list h3 {
            color: #065f46;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .card-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .flip-indicator {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-style: italic;
        }

        .mastery-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .mastery-badge.high {
            background: #d1fae5;
            color: #065f46;
        }

        .mastery-badge.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .mastery-badge.low {
            background: #fee2e2;
            color: #991b1b;
        }

        .keyboard-hint {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 20px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
        }

        .keyboard-hint .key {
            background: white;
            border: 2px solid #667eea;
            border-radius: 5px;
            padding: 5px 10px;
            font-family: monospace;
            font-weight: bold;
            color: #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .study-timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 15px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
        }

        .study-timer h4 {
            color: #667eea;
            margin: 0 0 8px 0;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .study-timer .time-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            font-family: monospace;
            text-align: center;
        }

        .study-timer .total-time {
            font-size: 0.8em;
            color: #666;
            margin-top: 8px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
            padding-top: 8px;
        }

        .study-timer .timer-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .study-timer .timer-btn {
            flex: 1;
            padding: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }

        .study-timer .timer-btn.pause {
            background: #ffc107;
            color: white;
        }

        .study-timer .timer-btn.resume {
            background: #10b981;
            color: white;
        }

        .study-timer .timer-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .circular-progress {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            position: relative;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .circular-progress circle {
            fill: none;
            stroke-width: 8;
        }

        .circular-progress .bg-circle {
            stroke: #e0e0e0;
        }

        .circular-progress .progress-circle {
            stroke: url(#gradient);
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease;
        }

        .circular-progress .percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .progress-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px;
        }

        .progress-badge.beginner {
            background: #fee2e2;
            color: #991b1b;
        }

        .progress-badge.learning {
            background: #fef3c7;
            color: #92400e;
        }

        .progress-badge.proficient {
            background: #dbeafe;
            color: #1e40af;
        }

        .progress-badge.expert {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-display {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }

        .achievement-badge {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            min-width: 150px;
            transition: all 0.3s;
        }

        .achievement-badge.earned {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            animation: badge-glow 2s infinite;
        }

        .achievement-badge.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        @keyframes badge-glow {
            0%, 100% {
                box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 5px 30px rgba(102, 126, 234, 0.6);
            }
        }

        .badge-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .badge-name {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .badge-desc {
            font-size: 0.85em;
            color: #666;
        }

        .streak-display {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .streak-display .streak-number {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .streak-display .streak-emoji {
            font-size: 2em;
        }

        .timeline-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            max-height: 600px;
        }

        .timeline-events {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }

        .timeline-events h3 {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            padding: 10px 0;
            margin: -10px 0 10px 0;
            z-index: 10;
        }

        .timeline-slots {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 3px dashed #667eea;
            max-height: 600px;
            overflow-y: auto;
        }

        .timeline-slots h3 {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            margin: -10px 0 10px 0;
            z-index: 10;
            border-bottom: 2px solid #e0e0e0;
        }

        /* Custom scrollbar styling for timeline panels */
        .timeline-events::-webkit-scrollbar,
        .timeline-slots::-webkit-scrollbar {
            width: 8px;
        }

        .timeline-events::-webkit-scrollbar-track,
        .timeline-slots::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .timeline-events::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .timeline-slots::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .timeline-events::-webkit-scrollbar-thumb:hover,
        .timeline-slots::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        /* Smooth scrolling */
        .timeline-events,
        .timeline-slots {
            scroll-behavior: smooth;
        }

        .timeline-event {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: move;
            transition: all 0.3s;
            user-select: none;
        }

        .timeline-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .timeline-event.dragging {
            opacity: 0.5;
        }

        .timeline-event.placed {
            cursor: default;
            background: #f0f0ff;
        }

        .timeline-event.correct {
            border-color: #10b981;
            background: #d1fae5;
        }

        .timeline-event.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
        }

        .timeline-event .event-title {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timeline-event .event-year {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .timeline-event .event-description {
            color: #666;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .timeline-event .drag-handle {
            color: #ccc;
            font-size: 1.2em;
            margin-right: 10px;
        }

        .timeline-slot {
            background: white;
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s;
        }

        .timeline-slot.drag-over {
            background: #e0e7ff;
            border-color: #667eea;
            border-style: solid;
        }

        .timeline-slot .slot-number {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .timeline-slot.filled {
            border-style: solid;
            border-color: #667eea;
        }

        .timeline-slot .empty-message {
            color: #999;
            font-style: italic;
        }

        .timeline-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .mode-btn:hover:not(.active) {
            border-color: #667eea;
            background: #f0f0ff;
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-200px) rotate(360deg); opacity: 0; }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 10000;
            animation: confetti 2s ease-out forwards;
        }

        @media (max-width: 768px) {
            .timeline-container {
                flex-direction: column;
            }

            .timeline-event {
                font-size: 0.9em;
            }
        }

        .mini-progress {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .mini-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                max-width: 100%;
            }

            .study-timer, .nav-btn, .btn, .keyboard-hint,
            .card-controls, .reset-btn, .timer-controls {
                display: none !important;
            }

            header {
                background: none;
                color: black;
                border-bottom: 3px solid #667eea;
                page-break-after: avoid;
            }

            .vocab-print-item {
                page-break-inside: avoid;
                margin-bottom: 20px;
                padding: 15px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
            }

            .vocab-print-item h3 {
                color: #667eea;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 600px) {
            .content {
                padding: 15px;
            }

            header h1 {
                font-size: 1.5em;
            }

            .nav-buttons {
                grid-template-columns: 1fr;
            }

            .flashcard {
                padding: 30px 20px;
                min-height: 250px;
            }

            .keyboard-hint {
                font-size: 0.8em;
                padding: 8px 12px;
                gap: 8px;
            }

            .study-timer {
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                min-width: 160px;
            }

            .study-timer .time-display {
                font-size: 1.4em;
            }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert.info {
            background: #dbeafe;
            border-left: 5px solid #3b82f6;
            color: #1e40af;
        }

        .alert.success {
            background: #d1fae5;
            border-left: 5px solid #10b981;
            color: #065f46;
        }

        .reset-btn {
            background: #fee2e2;
            color: #991b1b;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .reset-btn:hover {
            background: #fecaca;
        }


        .vocab-term {
            color: #667eea;
            font-weight: 600;
            cursor: help;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .vocab-term:hover {
            color: #764ba2;
        }

        .tooltip {
            position: fixed;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .tooltip h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .tooltip p {
            margin: 5px 0;
            line-height: 1.5;
        }

        .close-tooltip {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-size: 1.2em;
            color: #666;
        }

        .nav-btn i {
            font-size: 1.5em;
            margin-right: 8px;
            vertical-align: middle;
        }

        .alert i {
            font-size: 1.5em;
        }

    </style>
</head>
<body>
    <!-- Study Timer (shows on all pages except home) -->
    <div id="studyTimer" class="study-timer" style="display: none;">
        <h4><i class="fas fa-clock"></i> Study Session</h4>
        <div class="time-display" id="timerDisplay">00:00</div>
        <div class="total-time" id="totalTime">Total: 0h 0m</div>
        <div class="timer-controls">
            <button class="timer-btn pause" id="pauseBtn" onclick="toggleTimer()"><i class="fas fa-pause"></i> Pause</button>
        </div>
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-flag-usa"></i> Revolutionary War Study Tool</h1>
            <p>Get ready to ace your test! Learn vocabulary, practice questions, and track your progress.</p>
        </header>

        <div class="content">
            <!-- Tooltip for definitions -->
            <div id="definitionTooltip" class="tooltip">
                <span class="close-tooltip" onclick="closeTooltip()">✕</span>
                <div id="tooltipContent"></div>
            </div>

            <!-- HOME SECTION -->
            <div id="home" class="section active">
                <h2 style="margin-bottom: 20px;">Pick How You Want to Study</h2>
                
                <div id="overallProgress"></div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="showSection('vocab')">
                        <i class="fas fa-book"></i> Learn Vocabulary<br>
                        <small>Flip through flashcards (22 terms)</small>
                    </button>
                    <button class="nav-btn secondary" onclick="showSection('practice')">
                        <i class="fas fa-dumbbell"></i> Practice Mode<br>
                        <small>Get hints when you're wrong!</small>
                    </button>
                    <button class="nav-btn" onclick="showSection('timeline')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-clock"></i> Timeline Challenge<br>
                        <small>Put events in chronological order (9 events)</small>
                    </button>
                    <button class="nav-btn success" onclick="showSection('shortanswer')">
                        <i class="fas fa-pencil-alt"></i> Short Answer Practice<br>
                        <small>Practice writing responses</small>
                    </button>
                    <button class="nav-btn success" onclick="showSection('test')">
                        <i class="fas fa-check-circle"></i> Take a Practice Test<br>
                        <small>See if you're ready (30 questions)</small>
                    </button>
                    <button class="nav-btn" onclick="showSection('progress')">
                        <i class="fas fa-chart-line"></i> Check My Progress<br>
                        <small>What do I know? What do I need to work on?</small>
                    </button>
                    <button class="nav-btn" onclick="showSection('printguide')" style="background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 100%);">
                        <i class="fas fa-print"></i> Print Study Guide<br>
                        <small>Get a printable reference sheet</small>
                    </button>
                    <button class="nav-btn" onclick="showSection('focused')" style="background: linear-gradient(135deg, #FA709A 0%, #FEE140 100%);">
                        <i class="fas fa-brain"></i> Focused Study Mode<br>
                        <small>AI-powered practice for weak areas</small>
                    </button>
                    <button class="nav-btn" onclick="showSection('saveload')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-save"></i> Save & Load Progress<br>
                        <small>Backup your work or transfer to another device</small>
                    </button>
                </div>

                <div class="alert info">
                    <i class="fas fa-lightbulb"></i>
                    <div>
                        <strong>How to Study:</strong> Start with vocabulary flashcards to learn the words. Then do practice questions to test yourself. When you feel confident, take the full practice test!
                    </div>
                </div>
            </div>

            <!-- VOCABULARY SECTION -->
            <div id="vocab" class="section">
                <button class="btn btn-secondary" onclick="showSection('home')">← Back to Home</button>
                
                <h2 style="margin: 20px 0;">Vocabulary Flashcards</h2>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="vocabProgressBar" style="width: 0%"></div>
                    <div class="progress-text" id="vocabProgress">0/22 terms mastered (0%)</div>
                </div>

                <div id="flashcardContainer"></div>

                <div class="card-controls">
                    <button class="btn btn-secondary" onclick="prevCard()"><i class="fas fa-arrow-left"></i> Previous</button>
                    <button class="btn btn-primary" onclick="markKnown()"><i class="fas fa-check"></i> I Know This</button>
                    <button class="btn btn-secondary" onclick="nextCard()">Next <i class="fas fa-arrow-right"></i></button>
                </div>

                <p class="flip-indicator">Click the card to flip between term and definition</p>

                <div class="keyboard-hint">
                    <span><span class="key">←</span> <span class="key">→</span> Navigate cards</span>
                    <span><span class="key">Space</span> Flip card</span>
                    <span><span class="key">K</span> Mark known</span>
                    <span><span class="key">Esc</span> Home</span>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="shuffleCards()"><i class="fas fa-random"></i> Shuffle Cards</button>
                    <button class="reset-btn" onclick="resetVocabProgress()">Reset Vocabulary Progress</button>
                </div>
            </div>

            <!-- PRACTICE SECTION -->
            <div id="practice" class="section">
                <button class="btn btn-secondary" onclick="showSection('home')">← Back to Home</button>
                
                <h2 style="margin: 20px 0;">Practice Questions</h2>

                <div class="alert info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Practice Mode:</strong> Answer each question, then click "Check Answer" to see if you're right. If you get it wrong, you'll see an explanation to help you learn! <em>Click on any <span class="vocab-term">highlighted words</span> to see their definition.</em>
                    </div>
                </div>

                <div class="keyboard-hint">
                    <span><span class="key">1</span> <span class="key">2</span> <span class="key">3</span> <span class="key">4</span> Select answer</span>
                    <span><span class="key">Esc</span> Home</span>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="practiceProgressBar" style="width: 0%"></div>
                    <div class="progress-text" id="practiceProgress">Question 0 of 0</div>
                </div>

                <div id="practiceContainer"></div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="loadNewPracticeSet()"><i class="fas fa-sync-alt"></i> New Practice Set</button>
                </div>
            </div>

            <!-- SHORT ANSWER SECTION -->
            <div id="shortanswer" class="section">
                <button class="btn btn-secondary" onclick="showSection('home')"><i class="fas fa-arrow-left"></i> Back to Home</button>
                
                <h2 style="margin: 20px 0;">Short Answer Practice</h2>

                <div class="alert info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Practice Mode:</strong> Write your answer in the box, then reveal an example answer and self-assessment checklist. Compare your answer to see how you did!
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="shortAnswerProgressBar" style="width: 0%"></div>
                    <div class="progress-text" id="shortAnswerProgress">Question 0 of 5</div>
                </div>

                <div id="shortAnswerContainer"></div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="loadShortAnswers()"><i class="fas fa-sync-alt"></i> Start Over</button>
                </div>
            </div>

            <!-- TEST SECTION -->
            <div id="test" class="section">
                <button class="btn btn-secondary" onclick="showSection('home')">← Back to Home</button>
                
                <h2 style="margin: 20px 0;">Practice Test</h2>

                <div class="alert info">
                    <i class="fas fa-bolt"></i>
                    <div>
                        <strong>Test Mode:</strong> Answer all 30 questions, then see your results. No peeking at answers until the end!
                    </div>
                </div>

                <div class="keyboard-hint">
                    <span><span class="key">1</span> <span class="key">2</span> <span class="key">3</span> <span class="key">4</span> Select answer for question in view</span>
                    <span><span class="key">Esc</span> Home</span>
                </div>

                <div id="testContainer"></div>
            </div>

            <!-- PROGRESS SECTION -->
            <div id="progress" class="section">
                <button class="btn btn-secondary" onclick="showSection('home')">← Back to Home</button>
                
                <h2 style="margin: 20px 0;">Your Progress</h2>

                <div class="stats-grid" id="statsContainer"></div>

                <div id="weaknessContainer"></div>
                <div id="strengthContainer"></div>

                <div style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px;"><i class="fas fa-save"></i> Save & Load</h3>
                    <p style="margin-bottom: 15px; color: #666;">Save your progress to a file, or load previously saved progress:</p>
                    <button class="btn btn-primary" onclick="exportProgress()"><i class="fas fa-download"></i> Save My Progress</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Load Saved Progress</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importProgress(event)">
                </div>

                <button class="reset-btn" onclick="resetAllProgress()">Reset All Progress</button>
            </div>

            <!-- PRINT STUDY GUIDE SECTION -->
            <div id="printguide" class="section">
                <button class="btn btn-secondary" onclick="showSection('home')">← Back to Home</button>

                <h2 style="margin: 20px 0;">Print Study Guide</h2>

                <div class="alert info">
                    <i class="fas fa-print"></i>
                    <div>
                        <strong>Print This Guide:</strong> Click the "Print Study Guide" button below to generate a printer-friendly version. You can also filter by category to print only what you need!
                    </div>
                </div>

                <div style="margin: 20px 0;">
                    <label style="font-weight: 600; margin-right: 10px;">Filter by category:</label>
                    <select id="printCategory" onchange="updatePrintGuide()" style="padding: 8px 15px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 1em;">
                        <option value="all">All Categories</option>
                        <option value="Causes of Unrest">Causes of Unrest</option>
                        <option value="Uncovering Loyalties">Uncovering Loyalties</option>
                        <option value="Declaration">Declaration</option>
                    </select>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> Print Study Guide</button>
                    <button class="btn btn-secondary" onclick="markAllForPrint()"><i class="fas fa-check-square"></i> Select All for Study</button>
                    <button class="btn btn-secondary" onclick="markUnknownForPrint()"><i class="fas fa-exclamation-triangle"></i> Select Unknown Terms</button>
                </div>

                <div id="printGuideContent" style="margin-top: 30px;"></div>
            </div>

            <!-- FOCUSED STUDY MODE SECTION -->
            <div id="focused" class="section">
                <button class="btn btn-secondary" onclick="showSection('home')">← Back to Home</button>

                <h2 style="margin: 20px 0;">Focused Study Mode</h2>

                <div class="alert info">
                    <i class="fas fa-brain"></i>
                    <div>
                        <strong>Smart Practice:</strong> This mode analyzes your performance and creates a personalized study session focusing on your weak areas. It includes vocabulary you haven't mastered and topics where you've struggled.
                    </div>
                </div>

                <div id="focusedAnalysis"></div>

                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="startFocusedSession()" style="font-size: 1.2em; padding: 15px 40px;">
                        <i class="fas fa-play"></i> Start Focused Session
                    </button>
                </div>

                <div id="focusedContent"></div>
            </div>

            <!-- SAVE & LOAD SECTION -->
            <div id="saveload" class="section">
                <button class="btn btn-secondary" onclick="showSection('home')">← Back to Home</button>

                <h2 style="margin: 20px 0;"><i class="fas fa-save"></i> Save & Load Progress</h2>

                <div class="alert info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Why save your progress?</strong> Save your work to a file so you can:
                        <ul style="margin: 10px 0 0 20px;">
                            <li>Keep your progress safe if you clear your browser</li>
                            <li>Continue studying on a different computer or device</li>
                            <li>Share your progress with your teacher</li>
                        </ul>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
                    <div style="padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; text-align: center;">
                        <i class="fas fa-download" style="font-size: 3em; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 15px;">Save My Progress</h3>
                        <p style="margin-bottom: 20px; opacity: 0.9;">Download a file with all your progress - vocabulary, practice scores, test results, and badges.</p>
                        <button class="btn btn-primary" onclick="exportProgress()" style="background: white; color: #667eea; font-size: 1.1em; padding: 12px 30px;">
                            <i class="fas fa-download"></i> Save Now
                        </button>
                    </div>

                    <div style="padding: 30px; background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); border-radius: 15px; color: white; text-align: center;">
                        <i class="fas fa-upload" style="font-size: 3em; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 15px;">Load Saved Progress</h3>
                        <p style="margin-bottom: 20px; opacity: 0.9;">Upload a previously saved file to restore your progress from another session or device.</p>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFileMain').click()" style="background: white; color: #764ba2; font-size: 1.1em; padding: 12px 30px;">
                            <i class="fas fa-upload"></i> Load File
                        </button>
                        <input type="file" id="importFileMain" accept=".json" style="display: none;" onchange="importProgress(event)">
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Important Tips:</h4>
                    <ul style="margin: 10px 0 0 20px; color: #856404;">
                        <li>Save your progress regularly, especially before closing your browser</li>
                        <li>Keep the downloaded file in a safe place (like Google Drive or USB drive)</li>
                        <li>Loading a file will replace your current progress</li>
                        <li>The file is small and safe to email or share</li>
                    </ul>
                </div>
            </div>

            <!-- TIMELINE CHALLENGE SECTION -->
            <div id="timeline" class="section">
                <button class="btn btn-secondary" onclick="showSection('home')">← Back to Home</button>

                <h2 style="margin: 20px 0;"><i class="fas fa-clock"></i> Timeline Challenge</h2>

                <div class="alert info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Timeline Challenge:</strong> Arrange the 9 key events leading to the Revolutionary War in chronological order! Understanding the sequence helps you see how tensions escalated over time.
                    </div>
                </div>

                <div class="timeline-mode-toggle">
                    <button class="mode-btn" id="easyModeBtn" onclick="setTimelineMode('easy')">
                        <i class="fas fa-lightbulb"></i> Show Years (Help Me!)
                    </button>
                    <button class="mode-btn active" id="challengeModeBtn" onclick="setTimelineMode('challenge')">
                        <i class="fas fa-medal"></i> Challenge Mode (default)
                    </button>
                </div>

                <div class="keyboard-hint">
                    <span><span class="key">Click & Drag</span> Move events</span>
                    <span><span class="key">R</span> Restart</span>
                    <span><span class="key">Esc</span> Home</span>
                </div>

                <div id="timelineStats" style="text-align: center; margin: 20px 0; display: none;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; display: inline-block;">
                        <strong>Best Score:</strong> <span id="timelineBestScore">0</span>/9 |
                        <strong>Perfect Scores:</strong> <span id="timelinePerfectCount">0</span>/3 |
                        <strong>Attempts:</strong> <span id="timelineAttempts">0</span>
                    </div>
                </div>

                <div class="timeline-container" id="timelineContainer">
                    <div class="timeline-events">
                        <h3 style="margin-bottom: 20px; color: #667eea;">
                            <i class="fas fa-list"></i> Events to Arrange
                        </h3>
                        <div id="timelineEventsList"></div>
                    </div>

                    <div class="timeline-slots">
                        <h3 style="margin-bottom: 20px; color: #667eea;">
                            <i class="fas fa-sort-numeric-up"></i> Timeline (Drag events here)
                        </h3>
                        <div id="timelineSlotsList"></div>
                    </div>
                </div>

                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="checkTimelineAnswer()" id="checkTimelineBtn" style="font-size: 1.1em; padding: 12px 30px;">
                        <i class="fas fa-check-circle"></i> Check My Answer
                    </button>
                    <button class="btn btn-secondary" onclick="resetTimeline()" style="font-size: 1.1em; padding: 12px 30px;">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                    <button class="btn btn-secondary" onclick="showTimelineAnswer()" style="font-size: 1.1em; padding: 12px 30px;">
                        <i class="fas fa-eye"></i> Show Answer
                    </button>
                </div>

                <div id="timelineResults"></div>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA ====================

        // Timeline events in chronological order
        const timelineEvents = [
            {
                id: 1,
                title: "Proclamation of 1763",
                year: "1763",
                description: "Britain banned colonists from settling west of Appalachian Mountains"
            },
            {
                id: 2,
                title: "Stamp Act",
                year: "1765",
                description: "Tax on printed materials like newspapers and legal documents"
            },
            {
                id: 3,
                title: "Quartering Act",
                year: "1765",
                description: "Forced colonists to house and feed British soldiers"
            },
            {
                id: 4,
                title: "Townshend Acts",
                year: "1767",
                description: "Taxes on imported goods like tea, glass, and paper"
            },
            {
                id: 5,
                title: "Boston Massacre",
                year: "1770",
                description: "British soldiers killed 5 colonists including Crispus Attucks"
            },
            {
                id: 6,
                title: "Boston Tea Party",
                year: "1773",
                description: "Colonists dumped British tea into Boston Harbor to protest taxes"
            },
            {
                id: 7,
                title: "Intolerable Acts",
                year: "1774",
                description: "Harsh punishment laws targeting Massachusetts after the Tea Party"
            },
            {
                id: 8,
                title: "First Continental Congress",
                year: "1774",
                description: "Colonial leaders met to coordinate response to Britain"
            },
            {
                id: 9,
                title: "Lexington & Concord",
                year: "1775",
                description: "First battles of the Revolutionary War - 'shot heard round the world'"
            }
        ];

        const vocabulary = [
            {
                term: "Proclamation",
                definition: "An official announcement or order made by a government or ruler",
                example: "The Proclamation of 1763 banned colonists from settling west of the Appalachian Mountains",
                category: "Causes of Unrest"
            },
            {
                term: "Quarter/Quartering",
                definition: "To provide housing, food, and supplies to soldiers",
                example: "The Quartering Act forced colonists to house British soldiers in their homes",
                category: "Causes of Unrest"
            },
            {
                term: "Tax",
                definition: "Money that people are required to pay to the government",
                example: "The Stamp Act taxed printed materials like newspapers and legal documents",
                category: "Causes of Unrest"
            },
            {
                term: "Representation",
                definition: "Having someone speak and vote for you in government",
                example: "Colonists argued 'no taxation without representation' - they wanted a voice in Parliament",
                category: "Causes of Unrest"
            },
            {
                term: "Boycott",
                definition: "Refusing to buy or use certain goods as a form of protest",
                example: "Colonists boycotted British goods after the Stamp Act to pressure Britain economically",
                category: "Causes of Unrest"
            },
            {
                term: "Repeal",
                definition: "To officially cancel or revoke a law",
                example: "Britain repealed the Stamp Act in 1766 after massive colonial protests",
                category: "Causes of Unrest"
            },
            {
                term: "Intolerable (Coercive)",
                definition: "Too extreme or severe to be endured; unbearable",
                example: "The Intolerable Acts punished all of Massachusetts by closing Boston Harbor",
                category: "Causes of Unrest"
            },
            {
                term: "Minutemen",
                definition: "Colonial militia members ready to fight at a minute's notice",
                example: "Minutemen fought British troops at Lexington and Concord in April 1775",
                category: "Causes of Unrest"
            },
            {
                term: "Casualties",
                definition: "People killed or injured in a battle or conflict",
                example: "The Boston Massacre resulted in 5 casualties, including Crispus Attucks",
                category: "Causes of Unrest"
            },
            {
                term: "Escalation",
                definition: "When a conflict grows more intense or serious over time",
                example: "From 1763-1775, conflicts escalated from protests to armed rebellion",
                category: "Causes of Unrest"
            },
            {
                term: "Patriot",
                definition: "A colonist who supported independence from Britain",
                example: "Samuel Adams was a Patriot who organized protests against British policies",
                category: "Uncovering Loyalties"
            },
            {
                term: "Loyalist (Tory)",
                definition: "A colonist who remained loyal to King George III and Britain",
                example: "Many wealthy merchants were Loyalists because their business depended on British trade",
                category: "Uncovering Loyalties"
            },
            {
                term: "Neutral",
                definition: "Refusing to take sides in a conflict",
                example: "Some colonists stayed neutral to protect their families from retaliation",
                category: "Uncovering Loyalties"
            },
            {
                term: "Perspective",
                definition: "A person's point of view shaped by their experiences and identity",
                example: "Enslaved people had a different perspective on 'liberty' than wealthy colonists",
                category: "Uncovering Loyalties"
            },
            {
                term: "Rebellion",
                definition: "Armed resistance against a government or ruler",
                example: "British saw colonial resistance as illegal rebellion; colonists saw it as justified",
                category: "Uncovering Loyalties"
            },
            {
                term: "Independence",
                definition: "Freedom from being controlled by another country; self-governance",
                example: "The Declaration of Independence announced America's freedom from Britain",
                category: "Declaration"
            },
            {
                term: "Unalienable Rights",
                definition: "Rights that cannot be taken away - they belong to all people",
                example: "Jefferson listed life, liberty, and the pursuit of happiness as unalienable rights",
                category: "Declaration"
            },
            {
                term: "Consent of the Governed",
                definition: "Government power comes from the permission of the people it rules",
                example: "The Declaration says government needs consent of the governed to be legitimate",
                category: "Declaration"
            },
            {
                term: "Tyranny",
                definition: "Cruel, oppressive, and unjust use of power",
                example: "Jefferson accused King George of tyranny for taxing colonists without their consent",
                category: "Declaration"
            },
            {
                term: "Treason",
                definition: "The crime of betraying your country",
                example: "Signers of the Declaration could be hanged for treason against Britain",
                category: "Declaration"
            },
            {
                term: "Abolish",
                definition: "To completely eliminate or destroy something",
                example: "The Declaration says people can abolish government when it becomes destructive",
                category: "Declaration"
            },
            {
                term: "Usurpations",
                definition: "Illegal seizures of power or rights",
                example: "Jefferson accused the king of repeated usurpations of colonists' rights",
                category: "Declaration"
            }
        ];

        const questions = [
            {
                question: "The Proclamation of 1763 angered colonists because it:",
                options: [
                    "Raised taxes on tea and paper",
                    "Forced them to house British soldiers",
                    "Prevented them from settling west of the Appalachian Mountains",
                    "Closed Boston Harbor"
                ],
                correct: 2,
                explanation: "The Proclamation of 1763 banned colonists from settling west of the Appalachian Mountains. King George wanted to avoid conflicts with Native Americans, but colonists saw this as limiting their freedom and economic opportunities.",
                topic: "Causes of Unrest"
            },
            {
                question: "The Quartering Act required colonists to:",
                options: [
                    "Pay a tax on all printed materials",
                    "Provide housing and supplies for British soldiers",
                    "Attend church services every Sunday",
                    "Send their children to British schools"
                ],
                correct: 1,
                explanation: "The Quartering Act forced colonists to provide housing, food, and supplies to British soldiers. This was invasive and expensive, making colonists feel like their homes were being violated by an occupying army.",
                topic: "Causes of Unrest"
            },
            {
                question: "The colonial slogan 'No taxation without representation' meant that:",
                options: [
                    "Colonists refused to pay any taxes to anyone",
                    "Colonists believed they should only be taxed by their own elected representatives",
                    "Only British citizens should pay taxes",
                    "Taxes should be eliminated completely"
                ],
                correct: 1,
                explanation: "Colonists believed they should only be taxed by legislatures where they had elected representatives (like their colonial assemblies), not by British Parliament where they had no voice. This was a key principle behind their resistance.",
                topic: "Causes of Unrest"
            },
            {
                question: "The Stamp Act taxed colonists on:",
                options: [
                    "Imported goods like tea and glass",
                    "Land ownership in the western territories",
                    "Printed materials like newspapers and legal documents",
                    "Clothing and household items"
                ],
                correct: 2,
                explanation: "The Stamp Act (1765) required colonists to buy special stamped paper for newspapers, legal documents, pamphlets, and even playing cards. This was the first direct tax on colonists and affected nearly everyone, sparking widespread protests.",
                topic: "Causes of Unrest"
            },
            {
                question: "Which event involved British soldiers firing into a crowd, killing 5 people including Crispus Attucks?",
                options: [
                    "The Boston Tea Party",
                    "The Boston Massacre",
                    "Lexington and Concord",
                    "The Intolerable Acts"
                ],
                correct: 1,
                explanation: "The Boston Massacre (1770) occurred when British soldiers fired into a crowd of colonists, killing five people including Crispus Attucks, a Black sailor. Patriots used this event as propaganda to show British cruelty.",
                topic: "Causes of Unrest"
            },
            {
                question: "The Boston Tea Party was a colonial protest against:",
                options: [
                    "The Quartering Act",
                    "The Stamp Act",
                    "Taxes on tea imposed by the Townshend Acts",
                    "The Proclamation of 1763"
                ],
                correct: 2,
                explanation: "The Boston Tea Party (1773) was a protest against the tea tax from the Townshend Acts. Colonists, some disguised as Native Americans, dumped 342 chests of British tea into Boston Harbor to protest taxation without representation.",
                topic: "Causes of Unrest"
            },
            {
                question: "The Intolerable Acts were Britain's response to:",
                options: [
                    "The Stamp Act protests",
                    "The Boston Tea Party",
                    "The First Continental Congress",
                    "Lexington and Concord"
                ],
                correct: 1,
                explanation: "The Intolerable Acts (also called Coercive Acts) were passed in 1774 to punish Massachusetts for the Boston Tea Party. They closed Boston Harbor, removed self-government, and strengthened the Quartering Act.",
                topic: "Causes of Unrest"
            },
            {
                question: "The First Continental Congress met in Philadelphia to:",
                options: [
                    "Declare independence from Britain",
                    "Discuss how to respond to British policies and organize a boycott",
                    "Sign the Declaration of Independence",
                    "Elect George Washington as president"
                ],
                correct: 1,
                explanation: "The First Continental Congress (1774) brought together delegates from 12 of the 13 colonies to discuss coordinated responses to the Intolerable Acts. They organized a boycott and prepared for possible armed conflict.",
                topic: "Causes of Unrest"
            },
            {
                question: "The Battles of Lexington and Concord marked:",
                options: [
                    "The end of the Revolutionary War",
                    "The signing of the Declaration of Independence",
                    "The first military engagement of the Revolutionary War",
                    "The repeal of the Stamp Act"
                ],
                correct: 2,
                explanation: "Lexington and Concord (April 1775) was 'the shot heard round the world' - the first military engagement between British troops and colonial minutemen. This marked the transition from protest to armed rebellion.",
                topic: "Causes of Unrest"
            },
            {
                question: "In the 1776 musical, who was the main advocate pushing for independence?",
                options: [
                    "Benjamin Franklin",
                    "John Adams",
                    "Thomas Jefferson",
                    "George Washington"
                ],
                correct: 1,
                explanation: "John Adams was frustrated with Congress's reluctance to declare independence. The musical shows him constantly pushing the delegates to take action, even though many thought he was too aggressive.",
                topic: "1776 Musical"
            },
            {
                question: "According to the musical, why didn't Thomas Jefferson initially want to write the Declaration?",
                options: [
                    "He didn't believe in independence",
                    "He was too busy with military duties",
                    "He wanted to see his wife",
                    "He thought someone else was better qualified"
                ],
                correct: 2,
                explanation: "Jefferson was homesick and wanted to return to Virginia to see his wife Martha, who was in poor health. This made him reluctant to take on the writing task, even though he was chosen for his writing skills.",
                topic: "1776 Musical"
            },
            {
                question: "Who were the three most important members of the committee to write the Declaration?",
                options: [
                    "Adams, Washington, and Jefferson",
                    "Franklin, Washington, and Adams",
                    "Adams, Franklin, and Jefferson",
                    "Jefferson, Madison, and Hamilton"
                ],
                correct: 2,
                explanation: "The Committee of Five included Adams, Franklin, and Jefferson as the main contributors. Adams convinced Jefferson to write it, and Franklin helped edit. The other two members (Sherman and Livingston) played smaller roles.",
                topic: "1776 Musical"
            },
            {
                question: "In the slavery debate scene, who objected to the anti-slavery language?",
                options: [
                    "John Adams from Massachusetts",
                    "Benjamin Franklin from Pennsylvania",
                    "Edward Rutledge from South Carolina",
                    "Thomas Jefferson from Virginia"
                ],
                correct: 2,
                explanation: "Edward Rutledge from South Carolina objected because slavery was central to the Southern economy. He threatened that Southern colonies would not support independence if the anti-slavery language remained.",
                topic: "1776 Musical"
            },
            {
                question: "Why did Adams and Franklin agree to remove the anti-slavery language?",
                options: [
                    "They personally supported slavery",
                    "They needed all 13 colonies to unite for independence",
                    "King George demanded its removal",
                    "They planned to address slavery later in the Constitution"
                ],
                correct: 1,
                explanation: "Adams and Franklin faced an impossible choice: keep the anti-slavery language and lose Southern support, or remove it to keep all 13 colonies united. They chose unity for immediate independence, compromising on slavery.",
                topic: "1776 Musical"
            },
            {
                question: "Benjamin Franklin's quote 'If we do not hang together, we shall most assuredly hang separately' meant:",
                options: [
                    "They needed to celebrate their victory",
                    "They should all move to different colonies",
                    "If they didn't unite, the British would execute them individually for treason",
                    "Hanging was a common punishment in colonial times"
                ],
                correct: 2,
                explanation: "Franklin's play on words meant they needed to 'hang together' (stick together/unite) or they would 'hang separately' (be executed for treason). It emphasized the life-or-death stakes of signing the Declaration.",
                topic: "1776 Musical"
            },
            {
                question: "A 'Patriot' during the Revolutionary Era was someone who:",
                options: [
                    "Remained loyal to King George III",
                    "Supported independence from Britain",
                    "Refused to take sides in the conflict",
                    "Moved to Canada to avoid the war"
                ],
                correct: 1,
                explanation: "Patriots were colonists who supported independence from Britain and were willing to fight for it. They believed British policies violated their rights and that the colonies should be self-governing.",
                topic: "Uncovering Loyalties"
            },
            {
                question: "A 'Loyalist' (also called a Tory) was someone who:",
                options: [
                    "Supported independence from Britain",
                    "Remained loyal to the British Crown",
                    "Fought for Native American rights",
                    "Worked as a spy for both sides"
                ],
                correct: 1,
                explanation: "Loyalists remained loyal to King George III and Britain. They might have had family ties to Britain, business connections, government positions, or feared the chaos of revolution.",
                topic: "Uncovering Loyalties"
            },
            {
                question: "Someone who was 'neutral' during the Revolutionary War:",
                options: [
                    "Actively supported the Patriots",
                    "Actively supported the Loyalists",
                    "Did not take sides in the conflict",
                    "Fought for whichever side paid more"
                ],
                correct: 2,
                explanation: "Neutral colonists refused to take sides. They might have feared retaliation, had divided family loyalties, held religious beliefs against violence, or simply wanted to protect their property regardless of who won.",
                topic: "Uncovering Loyalties"
            },
            {
                question: "Which group might have been MOST likely to side with the British because they hoped for freedom?",
                options: [
                    "Wealthy colonial merchants",
                    "Enslaved people",
                    "Native Americans",
                    "Indentured servants"
                ],
                correct: 1,
                explanation: "Lord Dunmore's Proclamation (1775) promised freedom to enslaved people who joined British forces. Many enslaved people saw the British as offering a path to liberty that Patriots would not.",
                topic: "Uncovering Loyalties"
            },
            {
                question: "Why might different people have had different perspectives on independence?",
                options: [
                    "Their background, identity, and circumstances shaped their viewpoints",
                    "Some people were better educated than others",
                    "Everyone in each colony thought the same way",
                    "Only wealthy people had perspectives worth considering"
                ],
                correct: 0,
                explanation: "Perspective was shaped by identity - enslaved people wanted freedom, Native Americans worried about land, women had no political voice, wealthy colonists weighed economic interests. Different stakes = different viewpoints.",
                topic: "Uncovering Loyalties"
            },
            {
                question: "'Unalienable rights' in the Declaration of Independence means:",
                options: [
                    "Rights that can be taken away by the government",
                    "Rights that cannot be taken away",
                    "Rights only for wealthy white men",
                    "Rights that must be earned through service"
                ],
                correct: 1,
                explanation: "Unalienable rights cannot be taken away, given up, or transferred - they belong to all people simply by virtue of being human. Jefferson argued these rights were 'self-evident' and given by the Creator.",
                topic: "Declaration"
            },
            {
                question: "The three unalienable rights specifically mentioned in the Declaration are:",
                options: [
                    "Freedom, justice, and equality",
                    "Life, liberty, and the pursuit of happiness",
                    "Liberty, property, and security",
                    "Life, freedom, and prosperity"
                ],
                correct: 1,
                explanation: "Jefferson wrote 'We hold these truths to be self-evident, that all men are created equal, that they are endowed by their Creator with certain unalienable Rights, that among these are Life, Liberty and the pursuit of Happiness.'",
                topic: "Declaration"
            },
            {
                question: "'Consent of the governed' means:",
                options: [
                    "The government can do whatever it wants",
                    "Only rich people should vote",
                    "The government gets its power from the permission of the people",
                    "Kings have divine right to rule"
                ],
                correct: 2,
                explanation: "Consent of the governed means government only has legitimate authority if the people agree to be governed. This was revolutionary - it challenged the idea of monarchy based on divine right.",
                topic: "Declaration"
            },
            {
                question: "According to the Declaration, what should people do when government becomes destructive?",
                options: [
                    "Accept it because rebellion is wrong",
                    "Move to a different country",
                    "They have the right to change or abolish that government",
                    "Wait for the next election"
                ],
                correct: 2,
                explanation: "The Declaration states that when government repeatedly violates people's rights and becomes destructive, 'it is the Right of the People to alter or to abolish it, and to institute new Government.' This justified revolution.",
                topic: "Declaration"
            },
            {
                question: "The Declaration of Independence accused King George III of:",
                options: [
                    "Being too generous with the colonies",
                    "Multiple acts of tyranny and taking away colonists' rights",
                    "Not paying attention to the colonies",
                    "Starting the French and Indian War"
                ],
                correct: 1,
                explanation: "The Declaration lists over 25 grievances against King George - dissolving legislatures, imposing taxes without consent, quartering soldiers, blocking trade, denying trial by jury, and more. This documented his tyranny.",
                topic: "Declaration"
            },
            {
                question: "The colonists tried to resolve issues with Britain peacefully before declaring independence. This shows:",
                options: [
                    "The colonists were weak and afraid",
                    "Independence was a last resort after peaceful attempts failed",
                    "King George was willing to compromise",
                    "The colonists never really wanted independence"
                ],
                correct: 1,
                explanation: "The Declaration states they tried petitions and appeals many times ('In every stage of these Oppressions We have Petitioned for Redress'). This shows independence was justified only after exhausting peaceful solutions.",
                topic: "Declaration"
            },
            {
                question: "Whose voices and rights were LEFT OUT when Jefferson wrote 'all men are created equal'?",
                options: [
                    "Women, enslaved people, and Native Americans",
                    "Poor white men",
                    "Loyalists",
                    "British soldiers"
                ],
                correct: 0,
                explanation: "The Declaration's ideals excluded women (who couldn't vote or own property), enslaved people (who were considered property), and Native Americans (called 'merciless savages'). Even some white men without property couldn't vote.",
                topic: "Declaration"
            },
            {
                question: "The concept of 'escalation' means:",
                options: [
                    "Small conflicts build into larger ones over time",
                    "Britain became weaker as time went on",
                    "Colonists immediately wanted war after the first conflict",
                    "Events happened in random order with no connection"
                ],
                correct: 0,
                explanation: "Escalation describes how the conflict intensified over time - each British action led to stronger colonial reactions, which led to harsher British responses, creating a cycle that eventually led to war.",
                topic: "Connections"
            },
            {
                question: "Why does the ORDER of events matter when studying the causes of the Revolutionary War?",
                options: [
                    "It doesn't matter - events could have happened in any order",
                    "Each event built on previous tensions, showing how conflicts escalated",
                    "Only the first event matters",
                    "Only the last event matters"
                ],
                correct: 1,
                explanation: "The order matters because it shows escalation - how repeated grievances accumulated and peaceful attempts failed, making war seem inevitable by 1775. The pattern reveals cause-and-effect relationships.",
                topic: "Connections"
            },
            {
                question: "What connects ALL four activities (Causes of Unrest, 1776, Uncovering Loyalties, Declaration Translation)?",
                options: [
                    "They all focus on military battles",
                    "They all show that everyone agreed about independence",
                    "They help us understand WHY colonists declared independence and whose perspectives were included vs. excluded",
                    "They prove that Britain was always wrong"
                ],
                correct: 2,
                explanation: "All four activities connect to the unit's driving question: 'Whose story gets told? Whose gets left out?' They help us understand both the reasons for independence AND the voices missing from the story.",
                topic: "Connections"
            }
        ];

        // ==================== STATE MANAGEMENT ====================

        let currentCardIndex = 0;
        let cardFlipped = false;
        let vocabProgress = JSON.parse(localStorage.getItem('vocabProgress')) || [];
        let practiceProgress = JSON.parse(localStorage.getItem('practiceProgress')) || {};
        let testResults = JSON.parse(localStorage.getItem('testResults')) || [];
        let currentPracticeQuestions = [];
        let currentPracticeIndex = 0;

        // Study Timer
        let timerInterval = null;
        let sessionStartTime = null;
        let sessionElapsedTime = 0;
        let timerPaused = false;
        let totalStudyTime = parseInt(localStorage.getItem('totalStudyTime')) || 0;

        // Streak & Badges
        let studyStreak = JSON.parse(localStorage.getItem('studyStreak')) || { current: 0, longest: 0, lastStudyDate: null };
        let earnedBadges = JSON.parse(localStorage.getItem('earnedBadges')) || [];

        // Timeline Challenge
        let timelineProgress = JSON.parse(localStorage.getItem('timelineProgress')) || {
            bestScore: 0,
            perfectCount: 0,
            attempts: 0
        };
        let timelineMode = 'challenge'; // Start in challenge mode
        let timelinePlaced = {}; // Maps slot index to event id
        let draggedEvent = null;

        const badges = [
            { id: 'first_study', name: 'First Steps', icon: '👶', description: 'Complete your first study session', check: () => totalStudyTime > 0 },
            { id: 'vocab_5', name: 'Word Explorer', icon: '📚', description: 'Master 5 vocabulary terms', check: () => vocabProgress.length >= 5 },
            { id: 'vocab_all', name: 'Vocabulary Master', icon: '🎓', description: 'Master all vocabulary terms', check: () => vocabProgress.length >= vocabulary.length },
            { id: 'streak_3', name: 'Dedicated Student', icon: '🔥', description: 'Study 3 days in a row', check: () => studyStreak.current >= 3 },
            { id: 'streak_7', name: 'Week Warrior', icon: '⭐', description: 'Study 7 days in a row', check: () => studyStreak.current >= 7 },
            { id: 'practice_10', name: 'Practice Pro', icon: '💪', description: 'Complete 10 practice questions', check: () => Object.keys(practiceProgress).length >= 10 },
            { id: 'test_pass', name: 'Test Taker', icon: '✅', description: 'Score 80% or higher on a practice test', check: () => testResults.some(t => t.score >= 80) },
            { id: 'perfect_test', name: 'Perfect Score', icon: '💯', description: 'Get 100% on a practice test', check: () => testResults.some(t => t.score >= 100) },
            { id: 'study_hour', name: 'Time Traveler', icon: '⏰', description: 'Study for at least 1 hour total', check: () => totalStudyTime >= 3600000 },
            { id: 'timeline_master', name: 'Timeline Master', icon: '🕰️', description: 'Get perfect timeline score 3 times', check: () => timelineProgress.perfectCount >= 3 }
        ];

        // ==================== STUDY TIMER ====================

        function checkAndUpdateStreak() {
            const today = new Date().toDateString();
            const lastStudy = studyStreak.lastStudyDate;

            if (lastStudy !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastStudy === yesterday.toDateString()) {
                    // Continue streak
                    studyStreak.current++;
                } else if (lastStudy === null) {
                    // First time
                    studyStreak.current = 1;
                } else {
                    // Streak broken
                    studyStreak.current = 1;
                }

                studyStreak.lastStudyDate = today;
                studyStreak.longest = Math.max(studyStreak.longest, studyStreak.current);
                localStorage.setItem('studyStreak', JSON.stringify(studyStreak));
            }
        }

        function checkBadges() {
            let newBadges = [];

            badges.forEach(badge => {
                if (!earnedBadges.includes(badge.id) && badge.check()) {
                    earnedBadges.push(badge.id);
                    newBadges.push(badge);
                }
            });

            if (newBadges.length > 0) {
                localStorage.setItem('earnedBadges', JSON.stringify(earnedBadges));

                // Show notification for new badges
                newBadges.forEach(badge => {
                    showBadgeNotification(badge);
                });
            }
        }

        function showBadgeNotification(badge) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 3px solid #667eea;
                border-radius: 20px;
                padding: 30px;
                z-index: 10000;
                box-shadow: 0 10px 50px rgba(0,0,0,0.3);
                text-align: center;
                animation: badge-pop 0.5s ease;
            `;

            notification.innerHTML = `
                <div style="font-size: 4em; margin-bottom: 15px;">${badge.icon}</div>
                <h2 style="color: #667eea; margin-bottom: 10px;">Achievement Unlocked!</h2>
                <h3 style="margin-bottom: 10px;">${badge.name}</h3>
                <p style="color: #666;">${badge.description}</p>
                <button onclick="this.parentElement.remove()" style="
                    margin-top: 20px;
                    padding: 10px 30px;
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 1em;
                ">Awesome!</button>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function startTimer() {
            if (!timerInterval) {
                checkAndUpdateStreak();
                sessionStartTime = Date.now() - sessionElapsedTime;
                timerInterval = setInterval(updateTimer, 1000);
                timerPaused = false;
                updateTimerButton();
            }
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                // Save session time to total
                totalStudyTime += sessionElapsedTime;
                localStorage.setItem('totalStudyTime', totalStudyTime);
                sessionElapsedTime = 0;
                updateTotalTimeDisplay();
            }
        }

        function toggleTimer() {
            if (timerPaused) {
                // Resume
                sessionStartTime = Date.now() - sessionElapsedTime;
                timerInterval = setInterval(updateTimer, 1000);
                timerPaused = false;
            } else {
                // Pause
                clearInterval(timerInterval);
                timerInterval = null;
                timerPaused = true;
            }
            updateTimerButton();
        }

        function updateTimer() {
            sessionElapsedTime = Date.now() - sessionStartTime;
            const seconds = Math.floor(sessionElapsedTime / 1000);
            const minutes = Math.floor(seconds / 60);
            const displaySeconds = seconds % 60;

            document.getElementById('timerDisplay').textContent =
                `${String(minutes).padStart(2, '0')}:${String(displaySeconds).padStart(2, '0')}`;
        }

        function updateTimerButton() {
            const btn = document.getElementById('pauseBtn');
            if (timerPaused) {
                btn.className = 'timer-btn resume';
                btn.innerHTML = '<i class="fas fa-play"></i> Resume';
            } else {
                btn.className = 'timer-btn pause';
                btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
            }
        }

        function updateTotalTimeDisplay() {
            const totalMinutes = Math.floor(totalStudyTime / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            document.getElementById('totalTime').textContent = `Total: ${hours}h ${minutes}m`;
        }

        function showTimer() {
            document.getElementById('studyTimer').style.display = 'block';
            startTimer();
            updateTotalTimeDisplay();
        }

        function hideTimer() {
            document.getElementById('studyTimer').style.display = 'none';
            stopTimer();
        }

        // ==================== NAVIGATION ====================

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            // Show/hide timer based on section
            if (sectionId === 'home') {
                hideTimer();
                updateHomeProgress();
            } else {
                showTimer();
                if (sectionId === 'vocab') {
                    loadFlashcard();
                    updateVocabProgress();
                } else if (sectionId === 'practice') {
                    loadNewPracticeSet();
                } else if (sectionId === 'shortanswer') {
                    loadShortAnswers();
                } else if (sectionId === 'test') {
                    loadTest();
                } else if (sectionId === 'progress') {
                    loadProgressPage();
                } else if (sectionId === 'printguide') {
                    loadPrintGuide();
                } else if (sectionId === 'focused') {
                    loadFocusedMode();
                } else if (sectionId === 'timeline') {
                    loadTimeline();
                }
            }
        }

        // ==================== HOME PAGE ====================
        
        function createCircularProgress(percent, label) {
            const radius = 52;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;

            return `
                <div class="stat-card">
                    <div class="circular-progress">
                        <svg viewBox="0 0 120 120">
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <circle class="bg-circle" cx="60" cy="60" r="${radius}"/>
                            <circle class="progress-circle" cx="60" cy="60" r="${radius}"
                                stroke-dasharray="${circumference}"
                                stroke-dashoffset="${offset}"/>
                        </svg>
                        <div class="percentage">${percent}%</div>
                    </div>
                    <div class="label">${label}</div>
                </div>
            `;
        }

        function getProgressLevel(percent) {
            if (percent >= 90) return 'expert';
            if (percent >= 70) return 'proficient';
            if (percent >= 40) return 'learning';
            return 'beginner';
        }

        function getProgressLabel(percent) {
            if (percent >= 90) return 'Expert';
            if (percent >= 70) return 'Proficient';
            if (percent >= 40) return 'Learning';
            return 'Beginner';
        }

        function updateHomeProgress() {
            const vocabMastery = vocabulary.length > 0 ? (vocabProgress.length / vocabulary.length * 100).toFixed(0) : 0;
            const practiceTotal = Object.keys(practiceProgress).length;
            const practiceCorrect = Object.values(practiceProgress).filter(v => v === true).length;
            const practicePercent = practiceTotal > 0 ? (practiceCorrect / practiceTotal * 100).toFixed(0) : 0;

            const testsTotal = testResults.length;
            const avgTestScore = testsTotal > 0
                ? (testResults.reduce((sum, r) => sum + r.score, 0) / testsTotal).toFixed(0)
                : 0;

            let progressHTML = '<div class="stats-grid">';
            progressHTML += createCircularProgress(vocabMastery, 'Vocabulary Mastery');
            progressHTML += createCircularProgress(practicePercent, 'Practice Accuracy');

            if (testsTotal > 0) {
                progressHTML += createCircularProgress(avgTestScore, 'Test Average');
            }

            progressHTML += `
                <div class="stat-card">
                    <div class="number">${testsTotal}</div>
                    <div class="label">Practice Tests Taken</div>
                </div>
            `;

            progressHTML += '</div>';

            // Add progress badges
            const overallProgress = (parseFloat(vocabMastery) * 0.4) + (parseFloat(practicePercent) * 0.4) + (parseFloat(avgTestScore) * 0.2);
            const level = getProgressLevel(overallProgress);
            const levelLabel = getProgressLabel(overallProgress);

            progressHTML += `
                <div style="text-align: center; margin: 20px 0;">
                    <span class="progress-badge ${level}">
                        ${levelLabel} Level (${overallProgress.toFixed(0)}% Overall)
                    </span>
                </div>
            `;

            // Add "Email My Teacher" button if proficient or expert
            if (overallProgress >= 70) {
                progressHTML += `
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="btn btn-primary" onclick="showEmailTeacherForm()" style="font-size: 1.1em; padding: 15px 30px;">
                            <i class="fas fa-envelope"></i> Email My Teacher
                        </button>
                        <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                            You've reached ${overallProgress.toFixed(0)}% proficiency! Share your progress with your teacher.
                        </p>
                    </div>
                `;
            }

            // Add streak display
            if (studyStreak.current > 0) {
                progressHTML += `
                    <div class="streak-display">
                        <div class="streak-emoji">${studyStreak.current >= 7 ? '🔥🔥🔥' : studyStreak.current >= 3 ? '🔥🔥' : '🔥'}</div>
                        <div class="streak-number">${studyStreak.current}</div>
                        <div>Day Study Streak!</div>
                        <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">Longest: ${studyStreak.longest} days</div>
                    </div>
                `;
            }

            // Add recently earned badges
            const recentBadges = earnedBadges.slice(-3).reverse();
            if (recentBadges.length > 0) {
                progressHTML += '<h3 style="margin: 20px 0;">Recent Achievements</h3><div class="badge-display">';
                recentBadges.forEach(badgeId => {
                    const badge = badges.find(b => b.id === badgeId);
                    if (badge) {
                        progressHTML += `
                            <div class="achievement-badge earned">
                                <div class="badge-icon">${badge.icon}</div>
                                <div class="badge-name">${badge.name}</div>
                                <div class="badge-desc">${badge.description}</div>
                            </div>
                        `;
                    }
                });
                progressHTML += '</div>';
            }

            // Add readiness assessment with more encouraging language
            const totalProgress = (parseFloat(vocabMastery) * 0.4) + (parseFloat(practicePercent) * 0.4) + (parseFloat(avgTestScore) * 0.2);
            
            if (totalProgress >= 80) {
                progressHTML += `
                    <div class="alert success">
                        <i class="fas fa-star"></i>
                        <div>
                            <strong>You're crushing it!</strong> Your progress is ${totalProgress.toFixed(0)}%. You're totally ready for the real test!
                        </div>
                    </div>
                `;
            } else if (totalProgress >= 60) {
                progressHTML += `
                    <div class="alert info">
                        <i class="fas fa-dumbbell"></i>
                        <div>
                            <strong>You're doing great!</strong> Your progress is ${totalProgress.toFixed(0)}%. Keep practicing and you'll be ready soon!
                        </div>
                    </div>
                `;
            } else if (practiceTotal > 0 || vocabProgress.length > 0) {
                progressHTML += `
                    <div class="alert info">
                        <i class="fas fa-book-open"></i>
                        <div>
                            <strong>Good start!</strong> Your progress is ${totalProgress.toFixed(0)}%. Keep studying the vocabulary and doing practice questions!
                        </div>
                    </div>
                `;
            } else {
                progressHTML += `
                    <div class="alert info">
                        <i class="fas fa-hand-wave"></i>
                        <div>
                            <strong>Welcome!</strong> Start by learning vocabulary, then try some practice questions. You've got this!
                        </div>
                    </div>
                `;
            }

            const progressContainer = document.getElementById('overallProgress');
            if (progressContainer) {
                progressContainer.innerHTML = progressHTML;
            }
        }

        // ==================== VOCABULARY FLASHCARDS ====================
        
        function loadFlashcard() {
            cardFlipped = false;
            const card = vocabulary[currentCardIndex];
            
            const cardHTML = `
                <div class="flashcard" onclick="flipCard()">
                    <div id="cardFront">
                        <h3>${card.term}</h3>
                        <p style="margin-top: 10px; opacity: 0.8;">(${card.category})</p>
                    </div>
                    <div id="cardBack" style="display: none;">
                        <div class="definition">${card.definition}</div>
                        <div class="example"><strong>Example:</strong> ${card.example}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('flashcardContainer').innerHTML = cardHTML;
        }

        function flipCard() {
            cardFlipped = !cardFlipped;
            document.getElementById('cardFront').style.display = cardFlipped ? 'none' : 'block';
            document.getElementById('cardBack').style.display = cardFlipped ? 'block' : 'none';
        }

        function nextCard() {
            currentCardIndex = (currentCardIndex + 1) % vocabulary.length;
            loadFlashcard();
            updateVocabProgress();
        }

        function prevCard() {
            currentCardIndex = (currentCardIndex - 1 + vocabulary.length) % vocabulary.length;
            loadFlashcard();
            updateVocabProgress();
        }

        function markKnown() {
            const term = vocabulary[currentCardIndex].term;
            if (!vocabProgress.includes(term)) {
                vocabProgress.push(term);
                localStorage.setItem('vocabProgress', JSON.stringify(vocabProgress));
                checkBadges();
            }
            nextCard();
        }

        function shuffleCards() {
            for (let i = vocabulary.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [vocabulary[i], vocabulary[j]] = [vocabulary[j], vocabulary[i]];
            }
            currentCardIndex = 0;
            loadFlashcard();
        }

        function updateVocabProgress() {
            const percent = (vocabProgress.length / vocabulary.length * 100).toFixed(0);
            document.getElementById('vocabProgress').textContent = `${vocabProgress.length}/${vocabulary.length} terms mastered (${percent}%)`;
            document.getElementById('vocabProgressBar').style.width = `${percent}%`;

            // Add mini progress by category
            updateCategoryProgress();
        }

        function updateCategoryProgress() {
            const categories = {};
            vocabulary.forEach(v => {
                if (!categories[v.category]) {
                    categories[v.category] = { total: 0, known: 0 };
                }
                categories[v.category].total++;
                if (vocabProgress.includes(v.term)) {
                    categories[v.category].known++;
                }
            });

            let categoryHTML = '<div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">';
            categoryHTML += '<h4 style="margin-bottom: 15px; color: #667eea;">Progress by Category:</h4>';

            Object.entries(categories).forEach(([category, stats]) => {
                const percent = (stats.known / stats.total * 100).toFixed(0);
                categoryHTML += `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 0.9em; font-weight: 600;">${category}</span>
                            <span style="font-size: 0.9em; color: #666;">${stats.known}/${stats.total} (${percent}%)</span>
                        </div>
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            });

            categoryHTML += '</div>';

            const existingCategory = document.getElementById('categoryProgress');
            if (existingCategory) {
                existingCategory.innerHTML = categoryHTML;
            } else {
                const container = document.getElementById('vocab');
                const progressBar = container.querySelector('.progress-bar');
                const newDiv = document.createElement('div');
                newDiv.id = 'categoryProgress';
                newDiv.innerHTML = categoryHTML;
                progressBar.parentNode.insertBefore(newDiv, progressBar.nextSibling);
            }
        }

        function resetVocabProgress() {
            if (confirm('Are you sure you want to reset your vocabulary progress?')) {
                vocabProgress = [];
                localStorage.setItem('vocabProgress', JSON.stringify(vocabProgress));
                updateVocabProgress();
            }
        }

        // ==================== PRACTICE QUESTIONS ====================
        
        function loadNewPracticeSet() {
            // Select 10 random questions
            const shuffled = [...questions].sort(() => Math.random() - 0.5);
            currentPracticeQuestions = shuffled.slice(0, 10);
            currentPracticeIndex = 0;
            loadPracticeQuestion();
        }

        function loadPracticeQuestion() {
            if (currentPracticeIndex >= currentPracticeQuestions.length) {
                document.getElementById('practiceContainer').innerHTML = `
                    <div class="alert success">
                        <span style="font-size: 2em;">🎉</span>
                        <div>
                            <strong>Practice Set Complete!</strong> You've finished this set of questions. Click "New Practice Set" to try more!
                        </div>
                    </div>
                `;
                updatePracticeProgress();
                return;
            }

            const question = currentPracticeQuestions[currentPracticeIndex];
            const questionId = questions.indexOf(question);
            
            let questionHTML = `
                <div class="question-card">
                    <h3>Question ${currentPracticeIndex + 1} of ${currentPracticeQuestions.length}</h3>
                    <p style="margin: 15px 0; font-size: 1.1em;"><strong>${question.question}</strong></p>
                    <div class="options">
            `;
            
            question.options.forEach((option, index) => {
                questionHTML += `
                    <div class="option" onclick="selectPracticeOption(${questionId}, ${index})" id="practice-option-${index}">
                        <strong>${String.fromCharCode(65 + index)}.</strong> ${option}
                    </div>
                `;
            });
            
            questionHTML += `
                    </div>
                    <div id="practice-feedback" class="feedback"></div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" id="check-btn" onclick="checkPracticeAnswer(${questionId})" style="display: none;">Check Answer</button>
                        <button class="btn btn-primary" id="next-btn" onclick="nextPracticeQuestion()" style="display: none;">Next Question →</button>
                    </div>
                </div>
            `;
            
            document.getElementById('practiceContainer').innerHTML = questionHTML;
            updatePracticeProgress();
        }

        let selectedPracticeOption = -1;

        function selectPracticeOption(questionId, optionIndex) {
            // Remove previous selection
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Mark new selection
            document.getElementById(`practice-option-${optionIndex}`).classList.add('selected');
            selectedPracticeOption = optionIndex;
            
            // Show check button
            document.getElementById('check-btn').style.display = 'inline-block';
        }

        function checkPracticeAnswer(questionId) {
            const question = questions[questionId];
            const isCorrect = selectedPracticeOption === question.correct;

            // Update progress
            practiceProgress[questionId] = isCorrect;
            localStorage.setItem('practiceProgress', JSON.stringify(practiceProgress));
            checkBadges();
            
            // Show visual feedback on options
            document.querySelectorAll('.option').forEach((opt, index) => {
                opt.style.pointerEvents = 'none';
                if (index === question.correct) {
                    opt.classList.add('correct');
                } else if (index === selectedPracticeOption && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });
            
            // Show detailed feedback with highlighted vocab terms
            const feedbackDiv = document.getElementById('practice-feedback');
            feedbackDiv.className = `feedback show ${isCorrect ? 'correct' : 'incorrect'}`;
            feedbackDiv.innerHTML = `
                <h4>${isCorrect ? '<i class="fas fa-check-circle"></i> Yes! You got it!' : '<i class="fas fa-times-circle"></i> Not quite - but that\'s okay!'}</h4>
                <p><strong>Why this answer:</strong> ${highlightVocabTerms(question.explanation)}</p>
                <p style="margin-top: 10px;"><strong>Topic:</strong> ${question.topic}</p>
            `;
            
            // Hide check button, show next button
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function nextPracticeQuestion() {
            currentPracticeIndex++;
            selectedPracticeOption = -1;
            loadPracticeQuestion();
        }

        function updatePracticeProgress() {
            const text = `Question ${currentPracticeIndex + 1} of ${currentPracticeQuestions.length}`;
            const percent = ((currentPracticeIndex) / currentPracticeQuestions.length * 100).toFixed(0);
            document.getElementById('practiceProgress').textContent = text;
            document.getElementById('practiceProgressBar').style.width = `${percent}%`;
        }

        // ==================== PRACTICE TEST ====================
        
        let testAnswers = {};
        
        function loadTest() {
            testAnswers = {};

            let testHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" id="testProgressBar" style="width: 0%"></div>
                    <div class="progress-text" id="testProgress">0 of 30 answered</div>
                </div>
                <div id="testQuestions">
            `;
            
            questions.forEach((question, qIndex) => {
                testHTML += `
                    <div class="question-card">
                        <h3>Question ${qIndex + 1}</h3>
                        <p style="margin: 15px 0; font-size: 1.1em;"><strong>${question.question}</strong></p>
                        <div class="options">
                `;
                
                question.options.forEach((option, optIndex) => {
                    testHTML += `
                        <div class="option" onclick="selectTestOption(${qIndex}, ${optIndex})" id="test-q${qIndex}-opt${optIndex}">
                            <strong>${String.fromCharCode(65 + optIndex)}.</strong> ${option}
                        </div>
                    `;
                });
                
                testHTML += `
                        </div>
                    </div>
                `;
            });
            
            testHTML += `
                </div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="gradeTest()" style="font-size: 1.2em; padding: 15px 40px;">
                        Submit Test for Grading
                    </button>
                </div>
            `;
            
            document.getElementById('testContainer').innerHTML = testHTML;
            updateTestProgress();
        }

        function selectTestOption(questionIndex, optionIndex) {
            // Clear previous selection for this question
            for (let i = 0; i < 4; i++) {
                const opt = document.getElementById(`test-q${questionIndex}-opt${i}`);
                if (opt) opt.classList.remove('selected');
            }
            
            // Mark new selection
            document.getElementById(`test-q${questionIndex}-opt${optionIndex}`).classList.add('selected');
            testAnswers[questionIndex] = optionIndex;
            
            updateTestProgress();
        }

        function updateTestProgress() {
            const answered = Object.keys(testAnswers).length;
            const percent = (answered / questions.length * 100).toFixed(0);
            document.getElementById('testProgress').textContent = `${answered} of ${questions.length} answered`;
            document.getElementById('testProgressBar').style.width = `${percent}%`;
        }

        function gradeTest() {
            if (Object.keys(testAnswers).length < questions.length) {
                if (!confirm(`You've only answered ${Object.keys(testAnswers).length} of ${questions.length} questions. Submit anyway?`)) {
                    return;
                }
            }

            let correct = 0;
            let topicScores = {};
            let incorrectQuestions = [];
            
            questions.forEach((question, qIndex) => {
                const userAnswer = testAnswers[qIndex];
                const isCorrect = userAnswer === question.correct;
                
                if (isCorrect) {
                    correct++;
                } else {
                    incorrectQuestions.push({
                        question: question.question,
                        topic: question.topic,
                        correctAnswer: question.options[question.correct],
                        explanation: question.explanation
                    });
                }
                
                // Track by topic
                if (!topicScores[question.topic]) {
                    topicScores[question.topic] = { correct: 0, total: 0 };
                }
                topicScores[question.topic].total++;
                if (isCorrect) topicScores[question.topic].correct++;
                
                // Visual feedback
                const optDiv = document.getElementById(`test-q${qIndex}-opt${question.correct}`);
                if (optDiv) optDiv.classList.add('correct');
                
                if (userAnswer !== undefined && userAnswer !== question.correct) {
                    const wrongDiv = document.getElementById(`test-q${qIndex}-opt${userAnswer}`);
                    if (wrongDiv) wrongDiv.classList.add('incorrect');
                }
            });

            const score = (correct / questions.length * 100).toFixed(0);
            
            // Save result
            testResults.push({
                score: parseInt(score),
                date: new Date().toISOString(),
                topicScores: topicScores
            });
            localStorage.setItem('testResults', JSON.stringify(testResults));
            checkBadges();

            // Display results
            let resultsHTML = `
                <div class="alert ${score >= 80 ? 'success' : 'info'}">
                    <i class="fas ${score >= 80 ? 'fa-trophy' : 'fa-chart-bar'}"></i>
                    <div>
                        <h2 style="margin-bottom: 10px;">Test Complete!</h2>
                        <p style="font-size: 1.3em;"><strong>You got ${correct} out of ${questions.length} correct (${score}%)</strong></p>
                        ${score >= 90
                            ? '<p>Wow! You totally know this stuff! You\'re definitely ready! <i class="fas fa-star"></i></p>'
                            : score >= 80 
                            ? '<p>Great job! You\'re ready for the real test!</p>'
                            : score >= 70
                            ? '<p>Good work! Check out what you missed below and you\'ll be ready!</p>'
                            : score >= 60
                            ? '<p>You\'re getting there! Study the topics below and try again!</p>'
                            : '<p>Keep studying! Focus on the areas below where you need more practice.</p>'
                        }
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px 0;">How You Did On Each Topic:</h3>
                <div class="stats-grid">
            `;

            Object.entries(topicScores).forEach(([topic, scores]) => {
                const topicPercent = (scores.correct / scores.total * 100).toFixed(0);
                resultsHTML += `
                    <div class="stat-card">
                        <div class="number">${topicPercent}%</div>
                        <div class="label">${topic}<br>(${scores.correct}/${scores.total})</div>
                    </div>
                `;
            });

            resultsHTML += '</div>';

            if (incorrectQuestions.length > 0) {
                resultsHTML += `
                    <div class="weakness-list">
                        <h3><i class="fas fa-pencil-alt"></i> Questions to Study Again:</h3>
                `;
                
                incorrectQuestions.forEach((q, index) => {
                    resultsHTML += `
                        <div class="weakness-item">
                            <div>
                                <strong>${q.question}</strong><br>
                                <small style="color: #666;">Topic: ${q.topic}</small><br>
                                <small style="color: #059669;"><strong>The right answer:</strong> ${q.correctAnswer}</small><br>
                                <small>${highlightVocabTerms(q.explanation)}</small>
                            </div>
                        </div>
                    `;
                });
                
                resultsHTML += '</div>';
            }

            resultsHTML += `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="loadTest()">Take Another Practice Test</button>
                    <button class="btn btn-secondary" onclick="showSection('home')">Back to Home</button>
                </div>
            `;

            document.getElementById('testContainer').innerHTML = resultsHTML;
        }

        // ==================== PROGRESS PAGE ====================

        function loadProgressPage() {
            // Calculate stats
            const vocabMastery = (vocabProgress.length / vocabulary.length * 100).toFixed(0);
            const practiceTotal = Object.keys(practiceProgress).length;
            const practiceCorrect = Object.values(practiceProgress).filter(v => v === true).length;
            const practicePercent = practiceTotal > 0 ? (practiceCorrect / practiceTotal * 100).toFixed(0) : 0;

            const testsTotal = testResults.length;
            const avgTestScore = testsTotal > 0
                ? (testResults.reduce((sum, r) => sum + r.score, 0) / testsTotal).toFixed(0)
                : 0;

            // Format study time
            const totalMinutes = Math.floor(totalStudyTime / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const studyTimeDisplay = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

            // Stats cards
            let statsHTML = `
                <div class="stat-card">
                    <div class="number">${vocabProgress.length}/${vocabulary.length}</div>
                    <div class="label">Vocabulary Words You Know</div>
                </div>
                <div class="stat-card">
                    <div class="number">${practiceCorrect}/${practiceTotal}</div>
                    <div class="label">Practice Questions Right</div>
                </div>
                <div class="stat-card">
                    <div class="number">${testsTotal}</div>
                    <div class="label">Practice Tests Done</div>
                </div>
                <div class="stat-card">
                    <div class="number">${studyTimeDisplay}</div>
                    <div class="label">Total Study Time</div>
                </div>
            `;

            if (testsTotal > 0) {
                statsHTML += `
                    <div class="stat-card">
                        <div class="number">${avgTestScore}%</div>
                        <div class="label">Average Test Score</div>
                    </div>
                `;
            }
            
            document.getElementById('statsContainer').innerHTML = statsHTML;

            // Weakness analysis
            const unknownVocab = vocabulary.filter(v => !vocabProgress.includes(v.term));
            const incorrectPractice = Object.entries(practiceProgress)
                .filter(([qId, correct]) => !correct)
                .map(([qId]) => questions[parseInt(qId)]);

            let weaknessHTML = '';
            
            if (unknownVocab.length > 0 || incorrectPractice.length > 0) {
                weaknessHTML = '<div class="weakness-list"><h3><i class="fas fa-exclamation-triangle"></i> What You Should Study More:</h3>';
                
                if (unknownVocab.length > 0) {
                    weaknessHTML += `<p><strong>Vocabulary words you haven't learned yet (${unknownVocab.length} words):</strong></p>`;
                    unknownVocab.slice(0, 5).forEach(v => {
                        weaknessHTML += `<div class="weakness-item">${v.term} <span style="color: #666;">(${v.category})</span></div>`;
                    });
                    if (unknownVocab.length > 5) {
                        weaknessHTML += `<p style="margin-top: 10px;"><em>...and ${unknownVocab.length - 5} more. Go study them in the Vocabulary section!</em></p>`;
                    }
                }
                
                if (incorrectPractice.length > 0) {
                    const topicCounts = {};
                    incorrectPractice.forEach(q => {
                        topicCounts[q.topic] = (topicCounts[q.topic] || 0) + 1;
                    });
                    
                    weaknessHTML += `<p style="margin-top: 15px;"><strong>Topics where you got questions wrong:</strong></p>`;
                    Object.entries(topicCounts)
                        .sort((a, b) => b[1] - a[1])
                        .forEach(([topic, count]) => {
                            weaknessHTML += `<div class="weakness-item">${topic} <span class="mastery-badge low">${count} wrong</span></div>`;
                        });
                }
                
                weaknessHTML += '</div>';
            }
            
            document.getElementById('weaknessContainer').innerHTML = weaknessHTML;

            // Strength analysis
            let strengthHTML = '';
            
            if (vocabProgress.length > 0 || practiceCorrect > 0) {
                strengthHTML = '<div class="strength-list"><h3><i class="fas fa-check-circle"></i> What You Already Know Really Well:</h3>';
                
                if (vocabProgress.length > 0) {
                    const byCategory = {};
                    vocabProgress.forEach(term => {
                        const vocab = vocabulary.find(v => v.term === term);
                        if (vocab) {
                            byCategory[vocab.category] = (byCategory[vocab.category] || 0) + 1;
                        }
                    });
                    
                    strengthHTML += '<p><strong>Vocabulary you know, by category:</strong></p>';
                    Object.entries(byCategory).forEach(([category, count]) => {
                        const total = vocabulary.filter(v => v.category === category).length;
                        const percent = (count / total * 100).toFixed(0);
                        strengthHTML += `
                            <div class="weakness-item">
                                ${category} 
                                <span class="mastery-badge ${percent >= 80 ? 'high' : percent >= 60 ? 'medium' : 'low'}">
                                    ${count}/${total} (${percent}%)
                                </span>
                            </div>
                        `;
                    });
                }
                
                if (testsTotal > 0) {
                    const lastTest = testResults[testResults.length - 1];
                    strengthHTML += '<p style="margin-top: 15px;"><strong>Your last test scores by topic:</strong></p>';
                    Object.entries(lastTest.topicScores || {}).forEach(([topic, scores]) => {
                        const percent = (scores.correct / scores.total * 100).toFixed(0);
                        strengthHTML += `
                            <div class="weakness-item">
                                ${topic}
                                <span class="mastery-badge ${percent >= 80 ? 'high' : percent >= 60 ? 'medium' : 'low'}">
                                    ${percent}%
                                </span>
                            </div>
                        `;
                    });
                }
                
                strengthHTML += '</div>';
            }
            
            document.getElementById('strengthContainer').innerHTML = strengthHTML;

            // Badges section
            let badgesHTML = '<div style="margin: 30px 0;">';
            badgesHTML += '<h3 style="margin-bottom: 20px;"><i class="fas fa-trophy"></i> Achievements</h3>';

            if (studyStreak.current > 0) {
                badgesHTML += `
                    <div class="streak-display">
                        <div class="streak-emoji">${studyStreak.current >= 7 ? '🔥🔥🔥' : studyStreak.current >= 3 ? '🔥🔥' : '🔥'}</div>
                        <div class="streak-number">${studyStreak.current}</div>
                        <div>Day Study Streak!</div>
                        <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">Longest: ${studyStreak.longest} days</div>
                    </div>
                `;
            }

            badgesHTML += '<div class="badge-display">';

            badges.forEach(badge => {
                const earned = earnedBadges.includes(badge.id);
                badgesHTML += `
                    <div class="achievement-badge ${earned ? 'earned' : 'locked'}">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-desc">${badge.description}</div>
                    </div>
                `;
            });

            badgesHTML += '</div></div>';

            // Insert badges before the export section
            const weaknessContainer = document.getElementById('weaknessContainer');
            if (!document.getElementById('badgesContainer')) {
                const badgesDiv = document.createElement('div');
                badgesDiv.id = 'badgesContainer';
                badgesDiv.innerHTML = badgesHTML;
                weaknessContainer.parentNode.insertBefore(badgesDiv, weaknessContainer);
            } else {
                document.getElementById('badgesContainer').innerHTML = badgesHTML;
            }
        }

        function exportProgress() {
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                vocabProgress: vocabProgress,
                practiceProgress: practiceProgress,
                testResults: testResults,
                totalStudyTime: totalStudyTime,
                studyStreak: studyStreak,
                earnedBadges: earnedBadges,
                timelineProgress: timelineProgress,
                shortAnswerResponses: JSON.parse(localStorage.getItem('shortAnswerResponses')) || {}
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `revolution-review-progress-${dateStr}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('Progress exported successfully! Save this file to back up your data.');
        }

        function importProgress(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);

                    // Validate the data
                    if (!importData.version) {
                        throw new Error('Invalid file format');
                    }

                    if (confirm('This will replace your current progress. Continue?')) {
                        // Import all data
                        vocabProgress = importData.vocabProgress || [];
                        practiceProgress = importData.practiceProgress || {};
                        testResults = importData.testResults || [];
                        totalStudyTime = importData.totalStudyTime || 0;
                        studyStreak = importData.studyStreak || { current: 0, longest: 0, lastStudyDate: null };
                        earnedBadges = importData.earnedBadges || [];
                        timelineProgress = importData.timelineProgress || { bestScore: 0, perfectCount: 0, attempts: 0 };

                        // Save to localStorage
                        localStorage.setItem('vocabProgress', JSON.stringify(vocabProgress));
                        localStorage.setItem('practiceProgress', JSON.stringify(practiceProgress));
                        localStorage.setItem('testResults', JSON.stringify(testResults));
                        localStorage.setItem('totalStudyTime', totalStudyTime);
                        localStorage.setItem('studyStreak', JSON.stringify(studyStreak));
                        localStorage.setItem('earnedBadges', JSON.stringify(earnedBadges));
                        localStorage.setItem('timelineProgress', JSON.stringify(timelineProgress));

                        if (importData.shortAnswerResponses) {
                            localStorage.setItem('shortAnswerResponses', JSON.stringify(importData.shortAnswerResponses));
                        }

                        alert('Progress imported successfully!');
                        loadProgressPage();
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);

            // Reset the input so the same file can be imported again if needed
            event.target.value = '';
        }

        function resetAllProgress() {
            if (confirm('Are you sure you want to reset ALL your progress? This cannot be undone!')) {
                if (confirm('Really? This will delete all vocabulary progress, practice answers, and test results.')) {
                    localStorage.clear();
                    vocabProgress = [];
                    practiceProgress = {};
                    testResults = [];
                    totalStudyTime = 0;
                    alert('All progress has been reset!');
                    showSection('home');
                }
            }
        }

        // ==================== SHORT ANSWER PRACTICE ====================
        
        const shortAnswerQuestions = [
            {
                question: "The Tipping Point: Look at where you spent the MOST outrage points. Why did that event deserve the most? What made it cross the line from 'annoying' to 'unacceptable'?",
                topic: "Causes of Unrest",
                rubric: [
                    "Names a SPECIFIC event (like Boston Massacre, Intolerable Acts, etc.)",
                    "Explains WHY this event caused the most anger (3-4 sentences)",
                    "Uses specific details from what you learned (not just 'it was unfair')",
                    "Explains what made it a 'tipping point' - what was different about this event?"
                ],
                exemplar: "I gave the Intolerable Acts the most outrage points because they didn't just punish the people who did the Boston Tea Party - they punished everyone in Massachusetts. Britain closed Boston Harbor, which meant people couldn't work or get supplies, and they took away Massachusetts' right to govern themselves. What made this cross the line was that it showed Britain would use collective punishment and destroy an entire colony's freedom just to make a point. It proved that Britain didn't care about colonists' rights at all.",
                sentenceStarters: [
                    "I gave __________ the most points because...",
                    "This event was more serious than others because...",
                    "What made this cross the line was...",
                    "This showed colonists that..."
                ]
            },
            {
                question: "The Build-Up: The colonists didn't rebel after the Proclamation of 1763, but they DID rebel after Lexington and Concord. What changed over those 12 years? Why does the ORDER of events matter?",
                topic: "Causes of Unrest - Escalation",
                rubric: [
                    "Identifies the TIME SPAN (12 years from 1763-1775)",
                    "Explains that multiple events built up over time",
                    "Uses the word 'escalation' or describes how conflicts got worse",
                    "Gives at least 2-3 specific examples of events",
                    "Explains that peaceful solutions failed"
                ],
                exemplar: "Over those 12 years, the colonists tried many peaceful ways to solve problems with Britain, but each time Britain responded with harsher punishments. After the Stamp Act protests, Britain sent more troops. After the Boston Tea Party, they passed the Intolerable Acts. Each event made colonists angrier and more convinced that Britain wouldn't listen to them. The order matters because it shows escalation - how small conflicts built into bigger ones when neither side would compromise. By 1775 at Lexington and Concord, colonists felt they had no choice but to fight back because twelve years of petitions, boycotts, and peaceful protests had failed.",
                sentenceStarters: [
                    "Over 12 years, colonists...",
                    "Each event made things worse because...",
                    "The order matters because it shows...",
                    "By 1775, colonists felt..."
                ]
            },
            {
                question: "The Slavery Debate in 1776: Explain the 'impossible choice' that John Adams and Benjamin Franklin faced. What did Jefferson originally write? Who objected? What was removed and why?",
                topic: "1776 Musical",
                rubric: [
                    "States what Jefferson ORIGINALLY wrote (anti-slavery language)",
                    "Names who objected (Edward Rutledge or South Carolina)",
                    "Explains WHY they objected (economy, slavery was their 'way of life')",
                    "Describes the 'impossible choice' clearly",
                    "Explains what was removed",
                    "Shows understanding this wasn't because Adams/Franklin supported slavery"
                ],
                exemplar: "Jefferson originally wrote language in the Declaration blaming King George for the slave trade and condemning slavery. Edward Rutledge from South Carolina objected because slavery was central to the Southern economy and their entire way of life. The impossible choice was this: keep the anti-slavery language and lose Southern support for independence, or remove it to keep all 13 colonies united. Adams and Franklin chose to remove the anti-slavery language because they believed that without all colonies united, they couldn't win independence at all. This meant slavery would continue in America even though the Declaration said 'all men are created equal.'",
                sentenceStarters: [
                    "Jefferson originally wrote...",
                    "South Carolina objected because...",
                    "The impossible choice was...",
                    "Adams and Franklin removed it because...",
                    "This meant that..."
                ]
            },
            {
                question: "Multiple Perspectives: Choose ONE group (enslaved people, Native Americans, women, or wealthy colonists). Explain why their perspective on independence was different from the 'standard' Patriot narrative.",
                topic: "Uncovering Loyalties",
                rubric: [
                    "Chooses ONE specific group clearly",
                    "Explains how their IDENTITY shaped their perspective",
                    "Gives specific reasons why their viewpoint differed",
                    "Uses examples from the activities",
                    "Shows understanding that different groups had different concerns",
                    "4-5 complete sentences"
                ],
                exemplar: "Enslaved people had a very different perspective on independence than white Patriots. While Patriots fought for 'liberty' from British 'tyranny,' enslaved people had no liberty at all and many of their oppressors were the same people declaring independence. Some enslaved people actually sided with the British because Lord Dunmore's Proclamation promised freedom to any enslaved person who joined British forces. From their perspective, the Revolution's talk of freedom was hypocritical since the Declaration said 'all men are created equal' but didn't include them. Their main concern was escaping slavery, not whether Britain or colonists controlled the government.",
                sentenceStarters: [
                    "[Group] had a different perspective because...",
                    "While Patriots wanted...",
                    "From their perspective...",
                    "Their main concern was...",
                    "They might have sided with..."
                ]
            },
            {
                question: "Unalienable Rights vs. Reality: The Declaration states 'all men are created equal' with rights to 'life, liberty, and the pursuit of happiness.' Whose rights were protected in 1776? Whose rights were ignored? Give specific examples.",
                topic: "Declaration of Independence",
                rubric: [
                    "Identifies whose rights WERE protected (white men, property owners)",
                    "Names at least 2-3 groups whose rights were NOT protected",
                    "Gives specific examples of how they were excluded",
                    "Explains the CONTRADICTION between ideals and reality",
                    "Uses vocabulary from the Declaration",
                    "4-5 complete sentences"
                ],
                exemplar: "In 1776, the Declaration's rights were really only protected for white men who owned property. They could vote, own land, participate in government, and make decisions for the new nation. However, the rights were completely ignored for several groups. Enslaved people had no liberty at all and were considered property, not people with rights. Women couldn't vote, hold office, or own property independently because of coverture laws. Native Americans were excluded and even called 'savages' in the Declaration, with their land rights completely ignored. The contradiction is huge - Jefferson wrote 'all men are created equal' while he himself enslaved people, showing that 'unalienable rights' were actually very alienable depending on your race and gender.",
                sentenceStarters: [
                    "The Declaration's rights protected...",
                    "However, these groups were excluded:...",
                    "For example, enslaved people...",
                    "Women could not...",
                    "This shows that..."
                ]
            }
        ];

        let currentShortAnswerIndex = 0;
        let shortAnswerResponses = JSON.parse(localStorage.getItem('shortAnswerResponses')) || {};

        function loadShortAnswers() {
            currentShortAnswerIndex = 0;
            revealedStartersCount = 0;
            loadShortAnswerQuestion();
        }

        function loadShortAnswerQuestion() {
            if (currentShortAnswerIndex >= shortAnswerQuestions.length) {
                document.getElementById('shortAnswerContainer').innerHTML = `
                    <div class="alert success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>All Questions Complete!</strong> You've practiced all 5 short answer questions. Review your responses or start over to practice again!
                        </div>
                    </div>
                `;
                updateShortAnswerProgress();
                return;
            }

            const question = shortAnswerQuestions[currentShortAnswerIndex];
            const savedResponse = shortAnswerResponses[currentShortAnswerIndex] || '';

            let questionHTML = `
                <div class="question-card">
                    <h3>Question ${currentShortAnswerIndex + 1} of ${shortAnswerQuestions.length}</h3>
                    <p style="margin: 15px 0; font-size: 1.1em; line-height: 1.6;"><strong>${question.question}</strong></p>
                    <p style="color: #666; margin-bottom: 15px;"><strong>Topic:</strong> ${question.topic}</p>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #ffc107;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong><i class="fas fa-hands-helping"></i> Need help getting started?</strong>
                            <button class="btn btn-secondary" onclick="revealNextStarter()" id="starterBtn" style="padding: 5px 15px;">
                                <i class="fas fa-lightbulb"></i> Show Sentence Starter
                            </button>
                        </div>
                        <div id="sentenceStarters" style="margin-top: 10px; display: none;">
                            <ul style="margin: 10px 0 0 20px;" id="startersList">
                                <!-- Starters will be revealed one at a time -->
                            </ul>
                        </div>
                    </div>

                    <div style="background: #e0f2fe; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #0284c7;">
                        <strong><i class="fas fa-book-open"></i> Need more information?</strong>
                        <p style="margin: 10px 0 5px 0; font-size: 0.9em;">Review these resources if you're stuck:</p>
                        <div style="margin-top: 10px;">
                            ${getHelpLinks(question.topic)}
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Write your answer (4-5 sentences):</label>
                        <textarea
                            id="shortAnswerText"
                            style="width: 100%; min-height: 200px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; font-family: inherit; line-height: 1.6;"
                            placeholder="Start typing your answer here... Try writing on your own first before revealing sentence starters!"
                        >${savedResponse}</textarea>
                    </div>

                    <div style="text-align: center; margin: 20px 0;">
                        <button class="btn btn-primary" onclick="revealExemplar()"><i class="fas fa-eye"></i> Show Example Answer & Rubric</button>
                        <p style="margin-top: 10px; color: #666; font-size: 0.85em;">
                            <i class="fas fa-lightbulb"></i> Try writing your own answer first for the best learning!
                        </p>
                    </div>

                    <div id="answer-warning" style="display: none;"></div>

                    <div id="exemplar-section" style="display: none;">
                        <div style="background: #d1fae5; padding: 20px; border-radius: 10px; border-left: 5px solid #10b981; margin: 20px 0;">
                            <h4 style="color: #065f46; margin-bottom: 10px;"><i class="fas fa-star"></i> Example Answer (What a good response looks like):</h4>
                            <p style="line-height: 1.8;">${question.exemplar}</p>
                        </div>

                        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 5px solid #ffc107; margin: 20px 0;">
                            <h4 style="color: #856404; margin-bottom: 10px;"><i class="fas fa-clipboard-check"></i> Self-Assessment Checklist:</h4>
                            <p style="margin-bottom: 10px;">Compare your answer to this checklist. Did you:</p>
                            <ul style="margin-left: 20px;">
                                ${question.rubric.map(item => `<li style="margin: 8px 0;"><label><input type="checkbox"> ${item}</label></li>`).join('')}
                            </ul>
                        </div>

                        <div style="text-align: center; margin: 20px 0;">
                            <button class="btn btn-secondary" onclick="reviseAnswer()"><i class="fas fa-edit"></i> Revise My Answer</button>
                            <button class="btn btn-primary" onclick="nextShortAnswer()"><i class="fas fa-arrow-right"></i> Next Question</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('shortAnswerContainer').innerHTML = questionHTML;
            updateShortAnswerProgress();
        }

        let revealedStartersCount = 0;

        function revealNextStarter() {
            const question = shortAnswerQuestions[currentShortAnswerIndex];
            const startersDiv = document.getElementById('sentenceStarters');
            const startersList = document.getElementById('startersList');
            const starterBtn = document.getElementById('starterBtn');

            startersDiv.style.display = 'block';

            if (revealedStartersCount < question.sentenceStarters.length) {
                const starter = question.sentenceStarters[revealedStartersCount];
                const li = document.createElement('li');
                li.textContent = starter;
                li.style.marginBottom = '8px';
                li.style.animation = 'fadeIn 0.5s';
                startersList.appendChild(li);

                revealedStartersCount++;

                if (revealedStartersCount >= question.sentenceStarters.length) {
                    starterBtn.innerHTML = '<i class="fas fa-check"></i> All Starters Shown';
                    starterBtn.disabled = true;
                    starterBtn.style.opacity = '0.6';
                } else {
                    starterBtn.innerHTML = `<i class="fas fa-lightbulb"></i> Show Next Starter (${revealedStartersCount}/${question.sentenceStarters.length})`;
                }
            }
        }

        function getHelpLinks(topic) {
            // Map topics to appropriate help resources
            const links = {
                "Causes of Unrest": [
                    { title: "American Revolution - Britannica Kids", url: "https://kids.britannica.com/kids/article/American-Revolution/352838" },
                    { title: "Causes of the Revolutionary War - Kiddle", url: "https://kids.kiddle.co/American_Revolutionary_War" }
                ],
                "Causes of Unrest - Escalation": [
                    { title: "Road to Revolution Timeline - Britannica", url: "https://kids.britannica.com/kids/article/American-Revolution/352838" },
                    { title: "Revolutionary War Events - Kiddle", url: "https://kids.kiddle.co/American_Revolutionary_War" }
                ],
                "1776 Musical": [
                    { title: "Declaration of Independence - Britannica Kids", url: "https://kids.britannica.com/kids/article/Declaration-of-Independence/353133" },
                    { title: "Thomas Jefferson - Kiddle", url: "https://kids.kiddle.co/Thomas_Jefferson" }
                ],
                "Uncovering Loyalties": [
                    { title: "Different Perspectives in Revolution - Britannica", url: "https://kids.britannica.com/kids/article/American-Revolution/352838" },
                    { title: "Loyalists - Kiddle", url: "https://kids.kiddle.co/Loyalist_(American_Revolution)" }
                ],
                "Declaration of Independence": [
                    { title: "Declaration of Independence - Britannica Kids", url: "https://kids.britannica.com/kids/article/Declaration-of-Independence/353133" },
                    { title: "Declaration Text & History - Kiddle", url: "https://kids.kiddle.co/United_States_Declaration_of_Independence" }
                ]
            };

            const topicLinks = links[topic] || links["Causes of Unrest"];

            return topicLinks.map(link => `
                <a href="${link.url}" target="_blank" style="
                    display: inline-block;
                    margin: 5px 10px 5px 0;
                    padding: 8px 15px;
                    background: white;
                    color: #0284c7;
                    text-decoration: none;
                    border-radius: 8px;
                    border: 2px solid #0284c7;
                    font-size: 0.9em;
                    transition: all 0.3s;
                " onmouseover="this.style.background='#0284c7'; this.style.color='white';"
                   onmouseout="this.style.background='white'; this.style.color='#0284c7';">
                    <i class="fas fa-external-link-alt"></i> ${link.title}
                </a>
            `).join('');
        }

        function revealExemplar() {
            // Save current response
            const response = document.getElementById('shortAnswerText').value;
            shortAnswerResponses[currentShortAnswerIndex] = response;
            localStorage.setItem('shortAnswerResponses', JSON.stringify(shortAnswerResponses));

            // Check if they had a substantial attempt (more than 20 characters)
            const hadSubstantialAttempt = response.trim().length > 20;

            // Show warning if they haven't tried much
            const warningDiv = document.getElementById('answer-warning');
            if (!hadSubstantialAttempt) {
                warningDiv.innerHTML = `
                    <div class="alert info" style="margin: 20px 0;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Challenge yourself first!</strong> You'll learn more if you try writing your own answer before viewing the example. Once you view the answer, you won't be able to revise your response.
                        </div>
                    </div>
                `;
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }

            // Make textarea read-only to prevent copying the answer
            const textarea = document.getElementById('shortAnswerText');
            textarea.readOnly = true;
            textarea.style.background = '#f5f5f5';
            textarea.style.cursor = 'not-allowed';

            // Show exemplar and rubric
            document.getElementById('exemplar-section').style.display = 'block';

            // Update the Revise button based on whether they had an attempt
            const reviseBtn = document.querySelector('button[onclick="reviseAnswer()"]');
            if (hadSubstantialAttempt) {
                // They wrote something, so they can keep working on it
                reviseBtn.style.display = 'inline-block';
            } else {
                // They didn't write much, so hide the revise button to prevent copying
                reviseBtn.style.display = 'none';
            }

            // Scroll to exemplar
            document.getElementById('exemplar-section').scrollIntoView({ behavior: 'smooth' });
        }

        function reviseAnswer() {
            // Re-enable the textarea for revisions
            const textarea = document.getElementById('shortAnswerText');
            textarea.readOnly = false;
            textarea.style.background = 'white';
            textarea.style.cursor = 'text';

            // Hide exemplar and let them revise
            document.getElementById('exemplar-section').style.display = 'none';
            textarea.focus();

            // Scroll back to text area
            textarea.scrollIntoView({ behavior: 'smooth' });
        }

        function nextShortAnswer() {
            // Save current response
            const response = document.getElementById('shortAnswerText').value;
            shortAnswerResponses[currentShortAnswerIndex] = response;
            localStorage.setItem('shortAnswerResponses', JSON.stringify(shortAnswerResponses));

            // Reset starter count for next question
            revealedStartersCount = 0;

            // Move to next question
            currentShortAnswerIndex++;
            loadShortAnswerQuestion();
        }

        function updateShortAnswerProgress() {
            const percent = ((currentShortAnswerIndex) / shortAnswerQuestions.length * 100).toFixed(0);
            const progressEl = document.getElementById('shortAnswerProgress');
            const progressBarEl = document.getElementById('shortAnswerProgressBar');
            if (progressEl) {
                progressEl.textContent = `Question ${currentShortAnswerIndex + 1} of ${shortAnswerQuestions.length}`;
            }
            if (progressBarEl) {
                progressBarEl.style.width = `${percent}%`;
            }
        }

        // ==================== FOCUSED STUDY MODE ====================

        let focusedVocab = [];
        let focusedQuestions = [];
        let focusedIndex = 0;
        let focusedType = 'vocab'; // 'vocab' or 'question'

        function loadFocusedMode() {
            // Analyze weak areas
            const unknownVocab = vocabulary.filter(v => !vocabProgress.includes(v.term));
            const incorrectQuestions = Object.entries(practiceProgress)
                .filter(([qId, correct]) => !correct)
                .map(([qId]) => questions[parseInt(qId)]);

            // Get topics where performance is poor
            const topicPerformance = {};
            questions.forEach((q, qIndex) => {
                if (!topicPerformance[q.topic]) {
                    topicPerformance[q.topic] = { correct: 0, total: 0 };
                }
                if (practiceProgress[qIndex] !== undefined) {
                    topicPerformance[q.topic].total++;
                    if (practiceProgress[qIndex]) {
                        topicPerformance[q.topic].correct++;
                    }
                }
            });

            const weakTopics = Object.entries(topicPerformance)
                .filter(([topic, perf]) => perf.total > 0 && (perf.correct / perf.total) < 0.7)
                .map(([topic]) => topic);

            // Generate analysis
            let analysisHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">';
            analysisHTML += '<h3 style="margin-bottom: 15px; color: #667eea;"><i class="fas fa-chart-bar"></i> Your Weak Areas:</h3>';

            if (unknownVocab.length > 0) {
                analysisHTML += `
                    <div style="margin: 15px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                        <strong><i class="fas fa-book"></i> Vocabulary:</strong> ${unknownVocab.length} terms to master
                        <div style="margin-top: 8px; font-size: 0.9em;">
                            ${unknownVocab.slice(0, 5).map(v => v.term).join(', ')}${unknownVocab.length > 5 ? ` and ${unknownVocab.length - 5} more...` : ''}
                        </div>
                    </div>
                `;
            }

            if (weakTopics.length > 0) {
                analysisHTML += `
                    <div style="margin: 15px 0; padding: 15px; background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 8px;">
                        <strong><i class="fas fa-exclamation-triangle"></i> Topics needing practice:</strong>
                        <div style="margin-top: 8px;">
                            ${weakTopics.map(topic => {
                                const perf = topicPerformance[topic];
                                const percent = (perf.correct / perf.total * 100).toFixed(0);
                                return `<div style="margin: 5px 0;">${topic}: ${percent}% (${perf.correct}/${perf.total})</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            if (unknownVocab.length === 0 && weakTopics.length === 0) {
                analysisHTML += `
                    <div style="margin: 15px 0; padding: 15px; background: #d1fae5; border-left: 4px solid #10b981; border-radius: 8px;">
                        <strong><i class="fas fa-star"></i> Great job!</strong> You're doing well across all areas. Consider taking a practice test to verify your knowledge.
                    </div>
                `;
            }

            analysisHTML += '</div>';

            document.getElementById('focusedAnalysis').innerHTML = analysisHTML;
        }

        function startFocusedSession() {
            // Gather weak vocabulary
            focusedVocab = vocabulary.filter(v => !vocabProgress.includes(v.term));

            // Gather questions from weak topics
            const topicPerformance = {};
            questions.forEach((q, qIndex) => {
                if (!topicPerformance[q.topic]) {
                    topicPerformance[q.topic] = { correct: 0, total: 0, questions: [] };
                }
                if (practiceProgress[qIndex] !== undefined) {
                    topicPerformance[q.topic].total++;
                    if (practiceProgress[qIndex]) {
                        topicPerformance[q.topic].correct++;
                    }
                }
                topicPerformance[q.topic].questions.push({ question: q, index: qIndex });
            });

            const weakTopics = Object.entries(topicPerformance)
                .filter(([topic, perf]) => perf.total > 0 && (perf.correct / perf.total) < 0.7)
                .map(([topic]) => topic);

            focusedQuestions = [];
            weakTopics.forEach(topic => {
                const topicQuestions = topicPerformance[topic].questions
                    .filter(q => practiceProgress[q.index] === false || practiceProgress[q.index] === undefined)
                    .slice(0, 3);
                focusedQuestions.push(...topicQuestions);
            });

            // Shuffle both arrays
            focusedVocab.sort(() => Math.random() - 0.5);
            focusedQuestions.sort(() => Math.random() - 0.5);

            // Limit to reasonable size
            focusedVocab = focusedVocab.slice(0, 10);
            focusedQuestions = focusedQuestions.slice(0, 10);

            if (focusedVocab.length === 0 && focusedQuestions.length === 0) {
                alert('Great work! You have no weak areas to focus on. Try taking a full practice test!');
                return;
            }

            focusedIndex = 0;
            focusedType = focusedVocab.length > 0 ? 'vocab' : 'question';

            document.getElementById('focusedAnalysis').style.display = 'none';
            document.querySelector('#focused .btn-primary').style.display = 'none';

            showNextFocusedItem();
        }

        function showNextFocusedItem() {
            // Alternate between vocab and questions
            let contentHTML = '<div class="progress-bar" style="margin-bottom: 30px;">';
            const totalItems = focusedVocab.length + focusedQuestions.length;
            const progress = ((focusedIndex) / totalItems * 100).toFixed(0);
            contentHTML += `<div class="progress-fill" style="width: ${progress}%"></div>`;
            contentHTML += `<div class="progress-text">${focusedIndex}/${totalItems} completed (${progress}%)</div>`;
            contentHTML += '</div>';

            if (focusedIndex >= totalItems) {
                // Session complete
                contentHTML += `
                    <div class="alert success">
                        <i class="fas fa-trophy"></i>
                        <div>
                            <h2 style="margin-bottom: 10px;">Focused Session Complete!</h2>
                            <p>You've practiced ${focusedVocab.length} vocabulary terms and ${focusedQuestions.length} questions from your weak areas.</p>
                            <button class="btn btn-primary" onclick="showSection('home')" style="margin-top: 15px;">
                                Back to Home
                            </button>
                            <button class="btn btn-secondary" onclick="startFocusedSession()" style="margin-top: 15px;">
                                Start Another Session
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('focusedContent').innerHTML = contentHTML;
                checkBadges();
                return;
            }

            // Show vocab or question
            if (focusedType === 'vocab' && focusedVocab.length > 0) {
                const vocab = focusedVocab.shift();
                contentHTML += `
                    <div class="flashcard" id="focusedCard" style="cursor: pointer; position: relative;">
                        <div class="card-front">
                            <h3>${vocab.term}</h3>
                            <p style="margin-top: 10px; opacity: 0.8;">(${vocab.category})</p>
                            <p style="margin-top: 15px; font-size: 0.9em; color: rgba(255,255,255,0.8);">Click to see definition</p>
                        </div>
                    </div>
                    <div id="vocabDefinition" style="display: none; background: white; padding: 25px; border-radius: 15px; margin-top: 20px; border: 2px solid #667eea;">
                        <p style="margin: 10px 0; color: #333;"><strong>Definition:</strong> ${vocab.definition}</p>
                        <p style="margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; color: #333;"><strong>Example:</strong> ${vocab.example}</p>
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="markFocusedKnown('${vocab.term.replace(/'/g, "\\'")}')">
                                <i class="fas fa-check"></i> I Know This Now
                            </button>
                            <button class="btn btn-secondary" onclick="nextFocusedItem()">
                                Skip <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                `;
                focusedType = 'question';

                // Set up after DOM updates
                setTimeout(() => {
                    const card = document.getElementById('focusedCard');
                    if (card) {
                        card.addEventListener('click', function() {
                            document.getElementById('vocabDefinition').style.display = 'block';
                        });
                    }
                }, 0);
            } else if (focusedQuestions.length > 0) {
                const qData = focusedQuestions.shift();
                const question = qData.question;
                contentHTML += `
                    <div class="question-card">
                        <h3>Question from ${question.topic}</h3>
                        <p style="margin: 15px 0; font-size: 1.1em;"><strong>${question.question}</strong></p>
                        <div class="options">
                `;

                question.options.forEach((option, index) => {
                    contentHTML += `
                        <div class="option" onclick="selectFocusedOption(${index}, ${question.correct})" id="focused-opt-${index}">
                            <strong>${String.fromCharCode(65 + index)}.</strong> ${option}
                        </div>
                    `;
                });

                contentHTML += `
                        </div>
                        <div id="focused-feedback" class="feedback"></div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" id="focused-next-btn" onclick="nextFocusedItem()" style="display: none;">
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                `;
                focusedType = 'vocab';
            }

            document.getElementById('focusedContent').innerHTML = contentHTML;
        }

        let selectedFocusedOption = -1;

        function selectFocusedOption(optionIndex, correctIndex) {
            selectedFocusedOption = optionIndex;
            const isCorrect = optionIndex === correctIndex;

            // Visual feedback
            document.querySelectorAll('#focusedContent .option').forEach((opt, index) => {
                opt.style.pointerEvents = 'none';
                if (index === correctIndex) {
                    opt.classList.add('correct');
                } else if (index === optionIndex && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });

            // Show feedback
            const feedback = document.getElementById('focused-feedback');
            feedback.className = `feedback show ${isCorrect ? 'correct' : 'incorrect'}`;
            feedback.innerHTML = `
                <h4>${isCorrect ? '<i class="fas fa-check-circle"></i> Correct!' : '<i class="fas fa-times-circle"></i> Not quite'}</h4>
                <p>Keep practicing this topic!</p>
            `;

            document.getElementById('focused-next-btn').style.display = 'inline-block';
        }

        function markFocusedKnown(term) {
            if (!vocabProgress.includes(term)) {
                vocabProgress.push(term);
                localStorage.setItem('vocabProgress', JSON.stringify(vocabProgress));
                checkBadges();
            }
            nextFocusedItem();
        }

        function nextFocusedItem() {
            focusedIndex++;
            showNextFocusedItem();
        }

        // ==================== TIMELINE CHALLENGE ====================

        function loadTimeline() {
            updateTimelineStats();
            renderTimeline();
        }

        function renderTimeline() {
            // Randomize events for display
            const shuffled = [...timelineEvents].sort(() => Math.random() - 0.5);

            // Render events list
            let eventsHTML = '';
            shuffled.forEach(event => {
                const isPlaced = Object.values(timelinePlaced).includes(event.id);
                if (!isPlaced) {
                    eventsHTML += `
                        <div class="timeline-event" draggable="true" data-event-id="${event.id}"
                            ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
                            <div class="event-title">
                                <span class="drag-handle">⋮⋮</span>
                                ${event.title}
                                ${timelineMode === 'easy' ? `<span class="event-year">${event.year}</span>` : ''}
                            </div>
                            <div class="event-description">${event.description}</div>
                        </div>
                    `;
                }
            });
            document.getElementById('timelineEventsList').innerHTML = eventsHTML || '<p style="text-align: center; color: #999; padding: 20px;">All events placed!</p>';

            // Render timeline slots
            let slotsHTML = '';
            for (let i = 1; i <= 9; i++) {
                const eventId = timelinePlaced[i];
                const event = timelineEvents.find(e => e.id === eventId);

                slotsHTML += `
                    <div class="timeline-slot ${event ? 'filled' : ''}" data-slot="${i}"
                        ondragover="handleDragOver(event)" ondrop="handleDrop(event, ${i})" ondragleave="handleDragLeave(event)">
                        <div class="slot-number">${i}</div>
                `;

                if (event) {
                    slotsHTML += `
                        <div class="timeline-event placed" data-event-id="${event.id}" draggable="true"
                            ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)" onclick="removeFromSlot(${i})">
                            <div class="event-title">
                                ${event.title}
                                ${timelineMode === 'easy' ? `<span class="event-year">${event.year}</span>` : ''}
                            </div>
                            <div class="event-description">${event.description}</div>
                            <p style="font-size: 0.8em; color: #999; margin-top: 8px; text-align: center;">Click to remove</p>
                        </div>
                    `;
                } else {
                    slotsHTML += '<div class="empty-message">Drag an event here</div>';
                }

                slotsHTML += '</div>';
            }
            document.getElementById('timelineSlotsList').innerHTML = slotsHTML;
        }

        function handleDragStart(e) {
            const eventId = parseInt(e.target.closest('.timeline-event').dataset.eventId);
            draggedEvent = eventId;
            e.target.closest('.timeline-event').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.closest('.timeline-event').classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.target.closest('.timeline-slot').classList.add('drag-over');

            // Auto-scroll when dragging near edges
            const slotsContainer = document.querySelector('.timeline-slots');
            const rect = slotsContainer.getBoundingClientRect();
            const scrollThreshold = 100;
            const scrollSpeed = 10;

            if (e.clientY - rect.top < scrollThreshold) {
                slotsContainer.scrollTop -= scrollSpeed;
            } else if (rect.bottom - e.clientY < scrollThreshold) {
                slotsContainer.scrollTop += scrollSpeed;
            }
        }

        function handleDragLeave(e) {
            e.target.closest('.timeline-slot').classList.remove('drag-over');
        }

        function handleDrop(e, slotIndex) {
            e.preventDefault();
            e.target.closest('.timeline-slot').classList.remove('drag-over');

            if (draggedEvent) {
                // Remove from previous slot if exists
                Object.keys(timelinePlaced).forEach(key => {
                    if (timelinePlaced[key] === draggedEvent) {
                        delete timelinePlaced[key];
                    }
                });

                // Place in new slot
                timelinePlaced[slotIndex] = draggedEvent;
                draggedEvent = null;
                renderTimeline();
            }
        }

        function removeFromSlot(slotIndex) {
            delete timelinePlaced[slotIndex];
            renderTimeline();
        }

        function setTimelineMode(mode) {
            timelineMode = mode;
            document.getElementById('easyModeBtn').classList.toggle('active', mode === 'easy');
            document.getElementById('challengeModeBtn').classList.toggle('active', mode === 'challenge');
            renderTimeline();
        }

        function checkTimelineAnswer() {
            let correct = 0;
            const results = [];

            for (let i = 1; i <= 9; i++) {
                const placedEventId = timelinePlaced[i];
                const correctEventId = i;
                const isCorrect = placedEventId === correctEventId;

                if (isCorrect) correct++;

                results.push({
                    slot: i,
                    placedEventId,
                    correctEventId,
                    isCorrect
                });
            }

            // Update progress
            timelineProgress.attempts++;
            if (correct > timelineProgress.bestScore) {
                timelineProgress.bestScore = correct;
            }
            if (correct === 9) {
                timelineProgress.perfectCount++;
                showConfetti();
            }
            localStorage.setItem('timelineProgress', JSON.stringify(timelineProgress));
            updateTimelineStats();
            checkBadges();

            // Show visual feedback
            results.forEach(result => {
                const slot = document.querySelector(`.timeline-slot[data-slot="${result.slot}"]`);
                const eventCard = slot?.querySelector('.timeline-event');
                if (eventCard) {
                    if (result.isCorrect) {
                        eventCard.classList.add('correct');
                    } else {
                        eventCard.classList.add('incorrect');
                    }
                }
            });

            // Show results
            let resultsHTML = `
                <div class="alert ${correct === 9 ? 'success' : 'info'}" style="margin-top: 30px;">
                    <i class="fas ${correct === 9 ? 'fa-trophy' : 'fa-chart-line'}"></i>
                    <div>
                        <h3 style="margin-bottom: 10px;">Score: ${correct} out of 9 correct!</h3>
                        ${correct === 9 ? '<p><strong>Perfect! You mastered the timeline!</strong></p>' : ''}
                        ${correct < 9 ? '<p>Look at the events in red - those are in the wrong position. Try again!</p>' : ''}
                    </div>
                </div>
            `;

            if (correct < 9) {
                resultsHTML += '<div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 10px;">';
                resultsHTML += '<h4 style="color: #856404; margin-bottom: 15px;"><i class="fas fa-lightbulb"></i> Corrections:</h4>';
                results.forEach(result => {
                    if (!result.isCorrect) {
                        const correctEvent = timelineEvents.find(e => e.id === result.correctEventId);
                        const placedEvent = timelineEvents.find(e => e.id === result.placedEventId);
                        resultsHTML += `<p style="color: #856404; margin: 8px 0;">Position ${result.slot} should be <strong>${correctEvent?.title}</strong>${placedEvent ? `, not ${placedEvent.title}` : ' (empty)'}</p>`;
                    }
                });
                resultsHTML += '</div>';
            }

            document.getElementById('timelineResults').innerHTML = resultsHTML;
        }

        function showTimelineAnswer() {
            // Automatically place all events in correct order
            timelinePlaced = {};
            for (let i = 1; i <= 9; i++) {
                timelinePlaced[i] = i;
            }
            renderTimeline();

            document.getElementById('timelineResults').innerHTML = `
                <div class="alert info" style="margin-top: 30px;">
                    <i class="fas fa-eye"></i>
                    <div>
                        <p><strong>Answer revealed!</strong> Study the correct order, then click "Try Again" to practice.</p>
                    </div>
                </div>
            `;
        }

        function resetTimeline() {
            timelinePlaced = {};
            renderTimeline();
            document.getElementById('timelineResults').innerHTML = '';

            // Remove feedback classes
            document.querySelectorAll('.timeline-event').forEach(el => {
                el.classList.remove('correct', 'incorrect');
            });
        }

        function updateTimelineStats() {
            document.getElementById('timelineStats').style.display = timelineProgress.attempts > 0 ? 'block' : 'none';
            document.getElementById('timelineBestScore').textContent = timelineProgress.bestScore;
            document.getElementById('timelinePerfectCount').textContent = timelineProgress.perfectCount;
            document.getElementById('timelineAttempts').textContent = timelineProgress.attempts;
        }

        function showConfetti() {
            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = window.innerHeight + 'px';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 2000);
                }, i * 30);
            }
        }

        // ==================== PRINT STUDY GUIDE ====================

        let printSelection = [];

        function loadPrintGuide() {
            printSelection = vocabulary.map(v => v.term);
            updatePrintGuide();
        }

        function updatePrintGuide() {
            const category = document.getElementById('printCategory').value;
            const filteredVocab = category === 'all'
                ? vocabulary
                : vocabulary.filter(v => v.category === category);

            let guideHTML = '';

            filteredVocab.forEach((term, index) => {
                const isKnown = vocabProgress.includes(term.term);
                const isSelected = printSelection.includes(term.term);

                guideHTML += `
                    <div class="vocab-print-item" style="
                        border: 2px solid ${isKnown ? '#10b981' : '#e0e0e0'};
                        background: ${isSelected ? '#f8f9fa' : 'white'};
                        margin-bottom: 15px;
                        padding: 15px;
                        border-radius: 10px;
                        opacity: ${isSelected ? '1' : '0.6'};
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <h3 style="color: #667eea; margin: 0 0 5px 0;">${index + 1}. ${term.term}</h3>
                                <span style="font-size: 0.85em; color: #666;">${term.category}</span>
                                ${isKnown ? '<span style="margin-left: 10px; padding: 3px 10px; background: #d1fae5; color: #065f46; border-radius: 10px; font-size: 0.8em;"><i class="fas fa-check"></i> Known</span>' : ''}
                            </div>
                            <label style="cursor: pointer;">
                                <input type="checkbox"
                                    ${isSelected ? 'checked' : ''}
                                    onchange="togglePrintSelection('${term.term}')"
                                    style="width: 20px; height: 20px; cursor: pointer;">
                            </label>
                        </div>
                        <p style="margin: 10px 0;"><strong>Definition:</strong> ${term.definition}</p>
                        <p style="margin: 10px 0; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 5px;">
                            <strong>Example:</strong> ${term.example}
                        </p>
                    </div>
                `;
            });

            document.getElementById('printGuideContent').innerHTML = guideHTML;
        }

        function togglePrintSelection(term) {
            const index = printSelection.indexOf(term);
            if (index > -1) {
                printSelection.splice(index, 1);
            } else {
                printSelection.push(term);
            }
            updatePrintGuide();
        }

        function markAllForPrint() {
            const category = document.getElementById('printCategory').value;
            const filteredVocab = category === 'all'
                ? vocabulary
                : vocabulary.filter(v => v.category === category);

            printSelection = filteredVocab.map(v => v.term);
            updatePrintGuide();
        }

        function markUnknownForPrint() {
            const category = document.getElementById('printCategory').value;
            const filteredVocab = category === 'all'
                ? vocabulary
                : vocabulary.filter(v => v.category === category);

            printSelection = filteredVocab
                .filter(v => !vocabProgress.includes(v.term))
                .map(v => v.term);
            updatePrintGuide();
        }

        // ==================== DEFINITIONS ====================

        // Vocabulary terms for quick reference
        const vocabDefinitions = {};
        vocabulary.forEach(v => {
            vocabDefinitions[v.term.toLowerCase()] = {
                definition: v.definition,
                example: v.example,
                category: v.category
            };
        });

        // Show definition tooltip
        function showDefinition(term, event) {
            const tooltip = document.getElementById('definitionTooltip');
            const content = document.getElementById('tooltipContent');
            
            const vocab = vocabDefinitions[term.toLowerCase()];
            if (!vocab) return;
            
            content.innerHTML = `
                <h4>${term}</h4>
                <p><strong>Definition:</strong> ${vocab.definition}</p>
                <p><strong>Example:</strong> ${vocab.example}</p>
                <p style="color: #666; font-size: 0.9em; margin-top: 8px;">${vocab.category}</p>
            `;
            
            // Add close button with icon
            tooltip.querySelector('.close-tooltip').innerHTML = '<i class="fas fa-times"></i>';
            
            // Position tooltip near click
            tooltip.style.display = 'block';
            tooltip.style.left = Math.min(event.clientX + 10, window.innerWidth - 320) + 'px';
            tooltip.style.top = (event.clientY + 10) + 'px';
        }

        function closeTooltip() {
            document.getElementById('definitionTooltip').style.display = 'none';
        }

        // Close tooltip when clicking outside
        document.addEventListener('click', function(event) {
            const tooltip = document.getElementById('definitionTooltip');
            if (!event.target.classList.contains('vocab-term') && !tooltip.contains(event.target)) {
                closeTooltip();
            }
        });

        // Highlight vocabulary terms in text
        function highlightVocabTerms(text) {
            let highlighted = text;
            
            // Sort by length (longest first) to avoid partial matches
            const terms = Object.keys(vocabDefinitions).sort((a, b) => b.length - a.length);
            
            terms.forEach(term => {
                // Only highlight if it's a full word
                const regex = new RegExp(`\\b${term}\\b`, 'gi');
                highlighted = highlighted.replace(regex, function(match) {
                    return `<span class="vocab-term" onclick="showDefinition('${term}', event)">${match}</span>`;
                });
            });
            
            return highlighted;
        }

        // ==================== EMAIL TEACHER ====================

        function showEmailTeacherForm() {
            const vocabMastery = vocabulary.length > 0 ? (vocabProgress.length / vocabulary.length * 100).toFixed(0) : 0;
            const practiceTotal = Object.keys(practiceProgress).length;
            const practiceCorrect = Object.values(practiceProgress).filter(v => v === true).length;
            const practicePercent = practiceTotal > 0 ? (practiceCorrect / practiceTotal * 100).toFixed(0) : 0;
            const testsTotal = testResults.length;
            const avgTestScore = testsTotal > 0
                ? (testResults.reduce((sum, r) => sum + r.score, 0) / testsTotal).toFixed(0)
                : 0;
            const overallProgress = (parseFloat(vocabMastery) * 0.4) + (parseFloat(practicePercent) * 0.4) + (parseFloat(avgTestScore) * 0.2);

            const totalMinutes = Math.floor(totalStudyTime / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const studyTimeDisplay = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

            const formHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="emailModal">
                    <div style="background: white; padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <h2 style="color: #667eea; margin-bottom: 20px;"><i class="fas fa-envelope"></i> Email My Teacher</h2>

                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;">Your Progress Summary:</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="margin: 10px 0;"><strong>Overall Proficiency:</strong> ${overallProgress.toFixed(0)}%</li>
                                <li style="margin: 10px 0;"><strong>Vocabulary Mastery:</strong> ${vocabProgress.length}/${vocabulary.length} terms (${vocabMastery}%)</li>
                                <li style="margin: 10px 0;"><strong>Practice Accuracy:</strong> ${practiceCorrect}/${practiceTotal} correct (${practicePercent}%)</li>
                                <li style="margin: 10px 0;"><strong>Practice Tests:</strong> ${testsTotal} taken, ${avgTestScore}% average</li>
                                <li style="margin: 10px 0;"><strong>Study Time:</strong> ${studyTimeDisplay}</li>
                                <li style="margin: 10px 0;"><strong>Current Streak:</strong> ${studyStreak.current} days</li>
                                <li style="margin: 10px 0;"><strong>Badges Earned:</strong> ${earnedBadges.length}/${badges.length}</li>
                            </ul>
                        </div>

                        <form id="teacherEmailForm" onsubmit="sendEmailToTeacher(event)">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Your Name:</label>
                                <input type="text" id="studentName" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Feedback (Optional):</label>
                                <textarea id="studentFeedback" rows="5" placeholder="How helpful was this study tool? What could be improved?" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; resize: vertical;"></textarea>
                            </div>

                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" style="padding: 12px 30px; font-size: 1.1em;">
                                    <i class="fas fa-paper-plane"></i> Send Email
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="closeEmailModal()" style="padding: 12px 30px; font-size: 1.1em; margin-left: 10px;">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = formHTML;
            document.body.appendChild(modalDiv);
        }

        function closeEmailModal() {
            const modal = document.getElementById('emailModal');
            if (modal) {
                modal.parentElement.remove();
            }
        }

        function sendEmailToTeacher(event) {
            event.preventDefault();

            const studentName = document.getElementById('studentName').value;
            const feedback = document.getElementById('studentFeedback').value;

            const vocabMastery = vocabulary.length > 0 ? (vocabProgress.length / vocabulary.length * 100).toFixed(0) : 0;
            const practiceTotal = Object.keys(practiceProgress).length;
            const practiceCorrect = Object.values(practiceProgress).filter(v => v === true).length;
            const practicePercent = practiceTotal > 0 ? (practiceCorrect / practiceTotal * 100).toFixed(0) : 0;
            const testsTotal = testResults.length;
            const avgTestScore = testsTotal > 0
                ? (testResults.reduce((sum, r) => sum + r.score, 0) / testsTotal).toFixed(0)
                : 0;
            const overallProgress = (parseFloat(vocabMastery) * 0.4) + (parseFloat(practicePercent) * 0.4) + (parseFloat(avgTestScore) * 0.2);

            const totalMinutes = Math.floor(totalStudyTime / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const studyTimeDisplay = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

            // Build email subject and body
            const subject = `Revolutionary War Study Progress - ${studentName}`;
            const body = `Hello,

${studentName} has reached ${overallProgress.toFixed(0)}% proficiency on the Revolutionary War Study Tool!

PROGRESS SUMMARY:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Overall Proficiency: ${overallProgress.toFixed(0)}%
Vocabulary Mastery: ${vocabProgress.length}/${vocabulary.length} terms (${vocabMastery}%)
Practice Accuracy: ${practiceCorrect}/${practiceTotal} correct (${practicePercent}%)
Practice Tests Taken: ${testsTotal} (Average score: ${avgTestScore}%)
Total Study Time: ${studyTimeDisplay}
Current Study Streak: ${studyStreak.current} days
Longest Streak: ${studyStreak.longest} days
Badges Earned: ${earnedBadges.length}/${badges.length}

STUDENT FEEDBACK:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
${feedback || 'No feedback provided.'}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Sent from Revolutionary War Study Tool
Generated: ${new Date().toLocaleString()}`;

            // Create mailto link
            const mailtoLink = `mailto:benaderets885@edmonds.wednet.edu?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

            // Open email client
            window.location.href = mailtoLink;

            // Close modal after a brief delay
            setTimeout(() => {
                closeEmailModal();
                alert('Email opened! Please send the email from your email client.');
            }, 500);
        }

        // ==================== KEYBOARD NAVIGATION ====================

        document.addEventListener('keydown', function(event) {
            const activeSection = document.querySelector('.section.active').id;

            // Don't trigger keyboard shortcuts if user is typing
            if (event.target.tagName === 'TEXTAREA' || event.target.tagName === 'INPUT') {
                return;
            }

            // Vocabulary section controls
            if (activeSection === 'vocab') {
                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    prevCard();
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    nextCard();
                } else if (event.key === ' ' || event.key === 'Enter') {
                    event.preventDefault();
                    flipCard();
                } else if (event.key === 'k' || event.key === 'K') {
                    event.preventDefault();
                    markKnown();
                }
            }

            // Practice section controls
            if (activeSection === 'practice') {
                if (event.key >= '1' && event.key <= '4') {
                    event.preventDefault();
                    const optionIndex = parseInt(event.key) - 1;
                    const question = currentPracticeQuestions[currentPracticeIndex];
                    const questionId = questions.indexOf(question);
                    selectPracticeOption(questionId, optionIndex);
                }
            }

            // Test section controls
            if (activeSection === 'test') {
                if (event.key >= '1' && event.key <= '4') {
                    // Find which question is in view
                    const questionCards = document.querySelectorAll('#testQuestions .question-card');
                    questionCards.forEach((card, qIndex) => {
                        const rect = card.getBoundingClientRect();
                        if (rect.top >= 0 && rect.top <= window.innerHeight / 2) {
                            const optionIndex = parseInt(event.key) - 1;
                            selectTestOption(qIndex, optionIndex);
                        }
                    });
                }
            }

            // Timeline section controls
            if (activeSection === 'timeline') {
                if (event.key === 'r' || event.key === 'R') {
                    event.preventDefault();
                    resetTimeline();
                }
            }

            // Global: Escape to go home
            if (event.key === 'Escape' && activeSection !== 'home') {
                showSection('home');
            }
        });

        // ==================== INITIALIZATION ====================

        window.onload = function() {
            // Small delay to ensure DOM is ready
            setTimeout(() => {
                updateHomeProgress();
                showKeyboardHints();
            }, 100);
        };

        function showKeyboardHints() {
            // Add keyboard hints to the page
            const activeSection = document.querySelector('.section.active');
            if (!activeSection) return;

            // Don't show on home page
            if (activeSection.id === 'home') return;
        }
    </script>
</body>
</html>
